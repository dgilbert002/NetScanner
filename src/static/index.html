<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NetScanner - Family Network Monitor</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #667eea;
            --primary-dark: #5a67d8;
            --secondary: #764ba2;
            --success: #48bb78;
            --warning: #f6ad55;
            --danger: #fc8181;
            --dark: #2d3748;
            --gray: #718096;
            --light: #f7fafc;
            --border: #e2e8f0;
            --white: #ffffff;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: var(--white);
            color: var(--dark);
            overflow-x: hidden;
        }

        /* Top Status Bar */
        .status-bar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 44px;
            background: var(--white);
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 0 20px;
            z-index: 1001;
            border-bottom: 1px solid var(--border);
        }

        .app-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--primary);
        }

        /* Hamburger Menu */
        .hamburger {
            position: fixed;
            top: 12px;
            left: 20px;
            width: 24px;
            height: 24px;
            cursor: pointer;
            z-index: 1002;
            display: flex;
            flex-direction: column;
            justify-content: space-around;
        }

        .hamburger-line {
            width: 100%;
            height: 3px;
            background: var(--dark);
            border-radius: 2px;
            transition: all 0.3s ease;
        }

        .hamburger.active .hamburger-line:nth-child(1) {
            transform: rotate(45deg) translate(5px, 5px);
        }

        .hamburger.active .hamburger-line:nth-child(2) {
            opacity: 0;
        }

        .hamburger.active .hamburger-line:nth-child(3) {
            transform: rotate(-45deg) translate(7px, -6px);
        }

        /* Sidebar */
        .sidebar {
            position: fixed;
            left: -70%;
            top: 0;
            width: 70%;
            max-width: 300px;
            height: 100vh;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            padding: 60px 20px 20px;
            overflow-y: auto;
            z-index: 1000;
            transition: left 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .sidebar.active {
            left: 0;
        }

        .nav-menu {
            list-style: none;
        }

        .nav-item {
            margin-bottom: 8px;
        }

        .nav-link {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            color: rgba(255, 255, 255, 0.8);
            text-decoration: none;
            border-radius: 12px;
            transition: all 0.3s ease;
            font-size: 16px;
        }

        .nav-link:hover {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }

        .nav-link.active {
            background: rgba(255, 255, 255, 0.2);
            color: white;
        }

        .nav-icon {
            width: 20px;
            height: 20px;
        }

        .badge {
            margin-left: auto;
            padding: 4px 8px;
            background: var(--danger);
            color: white;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            min-width: 20px;
            text-align: center;
        }

        /* Main Content */
        .main-content {
            padding-top: 44px;
            min-height: 100vh;
            transition: margin-left 0.3s ease;
        }

        .main-content.sidebar-open {
            margin-left: 0;
        }

        /* Overlay for mobile */
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
            display: none;
        }

        .overlay.active {
            display: block;
        }

        /* Dashboard Content */
        .dashboard-content {
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }

        /* Profile Cards Grid */
        .profiles-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .profile-card {
            background: var(--white);
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            cursor: pointer;
            border: 2px solid transparent;
            position: relative;
        }

        .profile-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
            border-color: var(--primary);
        }

        .profile-alert-badge {
            position: absolute;
            top: 12px;
            right: 12px;
            background: var(--danger);
            color: white;
            font-size: 12px;
            font-weight: 600;
            padding: 4px 8px;
            border-radius: 12px;
            min-width: 18px;
            text-align: center;
            display: none;
        }

        .profile-header {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 16px;
        }

        .profile-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
            font-weight: 700;
            background-size: cover;
            background-position: center;
        }

        .profile-avatar img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
        }

        .profile-info h3 {
            font-size: 18px;
            font-weight: 600;
            color: var(--dark);
            margin-bottom: 4px;
        }

        .profile-info p {
            font-size: 14px;
            color: var(--gray);
        }

        .profile-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-top: 16px;
        }

        .stat-item {
            text-align: left;
            padding: 8px 0;
        }

        .stat-label {
            font-size: 12px;
            color: var(--gray);
            text-transform: uppercase;
            font-weight: 500;
            margin-bottom: 4px;
        }

        .stat-value {
            font-size: 14px;
            font-weight: 600;
            color: var(--dark);
        }

        .profile-status {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            margin-top: 12px;
        }

        .status-online {
            background: #c6f6d5;
            color: #22543d;
        }

        .status-offline {
            background: #fed7d7;
            color: #742a2a;
        }

        .status-away {
            background: #feebc8;
            color: #7c2d12;
        }

        /* Add Profile Button - Single Circle */
        .add-profile-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 200px;
        }

        .add-profile-button {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            border: none;
            font-size: 32px;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .add-profile-button:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 16px rgba(102, 126, 234, 0.5);
        }

        /* Profile Detail Section */
        .profile-detail {
            display: none;
            background: var(--white);
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }

        .profile-detail.active {
            display: block;
        }

        .profile-detail-header {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--border);
        }

        .back-button {
            background: none;
            border: none;
            font-size: 24px;
            color: var(--gray);
            cursor: pointer;
            padding: 8px;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .back-button:hover {
            background: var(--light);
            color: var(--dark);
        }

        .profile-detail-title {
            font-size: 24px;
            font-weight: 700;
            color: var(--dark);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .profile-detail-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid var(--primary);
        }

        .profile-detail-avatar-initials {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            font-weight: 600;
            border: 2px solid var(--primary);
        }

        /* Collapsible Sections */
        .collapsible-section {
            background: var(--white);
            border-radius: 12px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            margin-bottom: 16px;
            overflow: hidden;
        }

        .collapsible-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            border-bottom: 1px solid var(--border);
        }

        .collapsible-header:hover {
            background: var(--light);
        }

        .collapsible-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--dark);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .collapsible-count {
            font-size: 12px;
            color: var(--gray);
            font-weight: 500;
            margin-left: 8px;
        }

        .collapsible-total {
            font-size: 12px;
            color: var(--gray);
            font-weight: 500;
            margin-left: 8px;
        }

        .collapsible-icon {
            font-size: 18px;
            transition: transform 0.3s ease;
        }

        .collapsible-icon.expanded {
            transform: rotate(180deg);
        }

        .collapsible-badge {
            background: var(--danger);
            color: white;
            font-size: 12px;
            font-weight: 600;
            padding: 2px 8px;
            border-radius: 12px;
            min-width: 18px;
            text-align: center;
        }

        .collapsible-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .collapsible-content.expanded {
            max-height: 1000px;
        }

        .collapsible-body {
            padding: 20px;
        }

        /* Device Grid */
        .device-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 16px;
        }

        .device-card {
            background: var(--light);
            border-radius: 8px;
            padding: 16px;
            border: 1px solid var(--border);
            transition: all 0.3s ease;
        }

        .device-card:hover {
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .device-card.active {
            border-color: var(--success);
            background: rgba(72, 187, 120, 0.05);
        }

        .device-name {
            font-weight: 600;
            color: var(--dark);
            margin-bottom: 4px;
        }

        .device-info {
            font-size: 12px;
            color: var(--gray);
            margin-bottom: 8px;
        }

        .device-status {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
        }

        .device-last-seen {
            font-size: 11px;
            color: var(--gray);
            margin-top: 4px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--gray);
        }

        .status-dot.online {
            background: var(--success);
            animation: pulse 2s infinite;
        }

        .status-dot.active {
            background: var(--primary);
            animation: heartbeat 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        @keyframes heartbeat {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.2); }
        }

        /* App Categories */
        .app-category {
            margin-bottom: 16px;
        }

        .category-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            background: var(--light);
            border-radius: 8px;
            cursor: pointer;
            margin-bottom: 8px;
            transition: all 0.3s ease;
        }

        .category-header:hover {
            background: #e2e8f0;
        }

        .category-title {
            font-weight: 600;
            color: var(--dark);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .category-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--gray);
        }

        .category-dot.active {
            background: var(--success);
            animation: pulse 2s infinite;
        }

        .category-icon {
            font-size: 14px;
            transition: transform 0.3s ease;
        }

        .category-icon.expanded {
            transform: rotate(180deg);
        }

        .category-apps {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .category-apps.expanded {
            max-height: 500px;
        }

        .app-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            border-radius: 6px;
            margin-bottom: 4px;
            transition: all 0.3s ease;
        }

        .app-item:hover {
            background: var(--light);
        }

        .app-item.active {
            background: rgba(72, 187, 120, 0.1);
            border-left: 3px solid var(--success);
        }

        .app-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .app-icon {
            width: 32px;
            height: 32px;
            border-radius: 6px;
            background: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 14px;
            font-weight: 600;
        }

        .app-name {
            font-weight: 500;
            color: var(--dark);
        }

        .app-time {
            font-size: 12px;
            color: var(--gray);
        }

        .app-device {
            font-size: 10px;
            color: var(--gray);
            margin-top: 2px;
        }

        .app-last-accessed {
            font-size: 10px;
            color: var(--gray);
            margin-top: 2px;
        }

        .category-total {
            font-size: 12px;
            color: var(--gray);
            font-weight: 500;
        }

        .app-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: var(--gray);
        }

        .app-dot.active {
            background: var(--success);
            animation: heartbeat 1s infinite;
        }

        /* Alerts */
        .alert-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 8px;
            border-left: 4px solid var(--danger);
            background: rgba(252, 129, 129, 0.05);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .alert-item:hover {
            background: rgba(252, 129, 129, 0.1);
            transform: translateX(2px);
        }

        .alert-icon {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--danger);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
        }

        .alert-content {
            flex: 1;
        }

        .alert-title {
            font-weight: 600;
            color: var(--dark);
            margin-bottom: 2px;
        }

        .alert-description {
            font-size: 12px;
            color: var(--gray);
        }

        .alert-time {
            font-size: 11px;
            color: var(--gray);
        }

        .alert-actions {
            display: flex;
            justify-content: flex-end;
            margin-top: 12px;
        }

        .alert-action-btn {
            background: var(--light);
            border: 1px solid var(--border);
            color: var(--gray);
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .alert-action-btn:hover {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .alert-item.seen {
            opacity: 0.6;
            background: rgba(252, 129, 129, 0.02);
        }

        .alert-item.seen .alert-title {
            text-decoration: line-through;
        }

        /* App Timeline */
        .app-timeline {
            display: none;
            margin-top: 8px;
            margin-left: 20px;
            padding: 0;
        }

        .app-timeline.expanded {
            display: block;
        }

        .timeline-sessions {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .timeline-session {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 2px 0;
            font-size: 12px;
            color: var(--gray);
        }

        .timeline-dot {
            width: 4px;
            height: 4px;
            border-radius: 50%;
            background: var(--gray);
            flex-shrink: 0;
        }

        .timeline-times {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .timeline-duration {
            font-weight: 500;
            color: var(--dark);
        }

        /* Live Tab Styles */
        .live-filters {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .filter-section {
            margin-bottom: 20px;
        }

        .filter-section:last-child {
            margin-bottom: 0;
        }

        .filter-section h3 {
            margin: 0 0 15px 0;
            color: var(--dark);
            font-size: 1.1rem;
        }

        .filter-section h4 {
            margin: 0 0 10px 0;
            color: var(--gray);
            font-size: 0.9rem;
            font-weight: 600;
        }

        .time-filter-tabs {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .time-tab {
            padding: 8px 16px;
            border: 2px solid var(--border);
            border-radius: 20px;
            background: white;
            color: var(--gray);
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .time-tab:hover {
            border-color: var(--primary);
            color: var(--primary);
        }

        .time-tab.active {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
        }

        .profile-filters, .category-filters, .app-filters {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            width: 100%;
        }

        .filter-row {
            display: flex;
            gap: 20px;
            flex-wrap: nowrap;
            width: 100%;
        }

        .filter-group {
            flex: 1;
            min-width: 0;
            display: flex;
            flex-direction: column;
        }

        .filter-group h4 {
            margin: 0 0 8px 0;
            color: var(--gray);
            font-size: 0.9rem;
            font-weight: 600;
        }

        /* Live Profiles Section */
        .live-profiles-section {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .live-profiles-section h3 {
            margin: 0 0 15px 0;
            color: var(--dark);
            font-size: 1.1rem;
        }

        .live-profiles-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .live-profile-card {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 12px;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
            border: 2px solid transparent;
        }

        .live-profile-card:hover {
            background: #e9ecef;
            transform: translateY(-2px);
        }

        .live-profile-card.selected {
            border-color: var(--primary);
            background: rgba(102, 126, 234, 0.1);
        }

        .live-profile-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--primary);
            margin: 0 auto 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 1.2rem;
        }

        .live-profile-name {
            font-weight: 600;
            color: var(--dark);
            margin-bottom: 4px;
            font-size: 0.9rem;
        }

        .live-profile-status {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
            font-size: 0.75rem;
            color: var(--gray);
        }

        .live-status-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: var(--success);
            animation: pulse 2s infinite;
        }

        .live-status-dot.offline {
            background: var(--gray);
            animation: none;
        }

        .live-profile-time {
            font-size: 0.7rem;
            color: var(--gray);
            margin-top: 2px;
        }

        .filter-group {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
        }

        .category-filters, .app-filters {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .filter-chip {
            padding: 6px 12px;
            border: 1px solid var(--border);
            border-radius: 16px;
            background: white;
            color: var(--gray);
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .filter-chip:hover {
            border-color: var(--primary);
            color: var(--primary);
        }

        .filter-chip.selected {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
        }

        .filter-chip .count {
            background: rgba(255, 255, 255, 0.2);
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 0.75rem;
        }

        .live-traffic-section {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            overflow: hidden;
        }

        .traffic-header {
            padding: 20px;
            border-bottom: 1px solid var(--border);
        }

        .traffic-title-section {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .traffic-title-section h3 {
            margin: 0;
            color: var(--dark);
        }

        .traffic-controls {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .time-filter-section h4 {
            margin: 0 0 8px 0;
            color: var(--gray);
            font-size: 0.9rem;
            font-weight: 600;
        }

        .active-filters-section h4 {
            margin: 0 0 8px 0;
            color: var(--gray);
            font-size: 0.9rem;
            font-weight: 600;
        }

        .traffic-actions {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .alert-badge {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 12px;
            background: var(--danger);
            color: white;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .alert-badge:hover {
            background: #e53e3e;
            transform: translateY(-1px);
        }

        .alert-badge.filtered {
            background: var(--primary);
        }

        .alert-badge.filtered:hover {
            background: var(--primary-dark);
        }

        .alert-icon {
            font-size: 1rem;
        }

        .alert-count {
            background: rgba(255, 255, 255, 0.2);
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 0.8rem;
            min-width: 18px;
            text-align: center;
        }

        .active-filters {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .active-filter {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background: var(--primary);
            color: white;
            border-radius: 16px;
            font-size: 0.85rem;
        }

        .active-filter .remove {
            cursor: pointer;
            font-weight: bold;
            font-size: 1.1rem;
        }

        .active-filter .remove:hover {
            color: #ff6b6b;
        }

        .traffic-table-container {
            overflow-x: auto;
        }

        .traffic-table {
            width: 100%;
            border-collapse: collapse;
        }

        .traffic-table th {
            background: #f8f9fa;
            padding: 12px 8px;
            text-align: left;
            font-weight: 600;
            color: var(--gray);
            font-size: 0.85rem;
            border-bottom: 1px solid var(--border);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .traffic-table th.sortable {
            cursor: pointer;
            user-select: none;
            transition: background-color 0.3s ease;
        }

        .traffic-table th.sortable:hover {
            background: #e9ecef;
        }

        .sort-icon {
            margin-left: 5px;
            opacity: 0.5;
            transition: opacity 0.3s ease;
        }

        .traffic-table th.sort-asc .sort-icon::after {
            content: '↑';
            opacity: 1;
        }

        .traffic-table th.sort-desc .sort-icon::after {
            content: '↓';
            opacity: 1;
        }

        .traffic-table td {
            padding: 10px 8px;
            border-bottom: 1px solid #f1f3f4;
            font-size: 0.85rem;
            vertical-align: top;
        }

        .traffic-table tbody tr {
            transition: background-color 0.2s ease;
        }

        .traffic-table tbody tr:hover {
            background: #f8f9fa;
        }

        .traffic-table tbody tr.selected {
            background: #e3f2fd;
        }

        .device-info {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .device-name {
            font-weight: 600;
            color: var(--dark);
        }

        .device-ip {
            font-size: 0.75rem;
            color: var(--gray);
            font-family: 'Courier New', monospace;
        }

        .session-status {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .status-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .status-active {
            background: var(--success);
        }

        .status-inactive {
            background: var(--gray);
            animation: none;
        }

        .accessing-info {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .accessing-app {
            font-weight: 500;
            color: var(--dark);
        }

        .accessing-time {
            font-size: 0.75rem;
            color: var(--gray);
        }

        .duration-info {
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            color: var(--dark);
        }

        .data-info {
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            color: var(--dark);
        }

        .ip-mac {
            font-family: 'Courier New', monospace;
            font-size: 0.8rem;
        }

        .ip-address {
            color: var(--primary);
            font-weight: 500;
        }

        .mac-address {
            color: var(--gray);
        }

        .category-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 500;
            text-transform: uppercase;
        }

        .category-social { background: #e3f2fd; color: #1976d2; }
        .category-gaming { background: #f3e5f5; color: #7b1fa2; }
        .category-work { background: #e8f5e8; color: #388e3c; }
        .category-education { background: #fff3e0; color: #f57c00; }
        .category-entertainment { background: #fce4ec; color: #c2185b; }
        .category-unknown { background: #f5f5f5; color: #757575; }

        .app-info {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .app-name {
            font-weight: 500;
            color: var(--dark);
        }

        .app-url {
            font-size: 0.75rem;
            color: var(--gray);
            font-family: 'Courier New', monospace;
        }

        .target-info {
            font-family: 'Courier New', monospace;
            font-size: 0.8rem;
        }

        .target-resolved {
            color: var(--success);
            font-weight: 500;
        }

        .target-unresolved {
            color: var(--warning);
        }

        .protocol-badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 8px;
            font-size: 0.7rem;
            font-weight: 500;
            text-transform: uppercase;
        }

        .protocol-http { background: #e3f2fd; color: #1976d2; }
        .protocol-https { background: #e8f5e8; color: #388e3c; }
        .protocol-tcp { background: #fff3e0; color: #f57c00; }
        .protocol-udp { background: #fce4ec; color: #c2185b; }

        .data-usage {
            font-family: 'Courier New', monospace;
            font-size: 0.8rem;
            color: var(--gray);
        }

        .timestamp {
            font-size: 0.8rem;
            color: var(--gray);
        }

        .clickable-cell {
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .clickable-cell:hover {
            background: rgba(102, 126, 234, 0.1);
        }

        .clickable-cell.filtered {
            background: rgba(102, 126, 234, 0.2);
            font-weight: 600;
        }

        .quick-actions { display: flex; gap: 8px; align-items: center; }
        .quick-action { color: var(--primary); font-size: 0.85rem; cursor: pointer; user-select: none; }
        .quick-action:hover { text-decoration: underline; }

        /* Devices Section Styles */
        .devices-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 0 20px;
        }

        .devices-controls {
            display: flex;
            gap: 10px;
        }

        .refresh-button, .scan-button {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: white;
            color: var(--gray);
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }

        .refresh-button:hover, .scan-button:hover {
            border-color: var(--primary);
            color: var(--primary);
            background: rgba(102, 126, 234, 0.05);
        }

        .devices-table-container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            overflow: hidden;
        }

        .devices-table {
            width: 100%;
            border-collapse: collapse;
        }

        .devices-table th {
            background: var(--light);
            padding: 16px 12px;
            text-align: left;
            font-weight: 600;
            color: var(--gray);
            border-bottom: 1px solid var(--border);
            cursor: pointer;
            user-select: none;
        }

        .devices-table th.sortable:hover {
            background: rgba(102, 126, 234, 0.05);
        }

        .devices-table td {
            padding: 12px;
            border-bottom: 1px solid var(--border);
            vertical-align: middle;
        }

        .devices-table tbody tr:hover {
            background: rgba(102, 126, 234, 0.02);
        }

        .device-info .device-name { font-weight: 600; color: var(--dark); }
        .device-info .device-ip { font-family: 'Courier New', monospace; color: var(--gray); }
        .device-info .device-mac { font-family: 'Courier New', monospace; color: var(--gray); font-size: 0.9rem; }
        .session-status { display: flex; align-items: center; gap: 8px; }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .status-online {
            background: var(--success);
        }

        .status-offline {
            background: var(--gray);
        }

        .device-actions-cell {
            text-align: center;
        }

        .details-button {
            padding: 6px 12px;
            border: 1px solid var(--primary);
            border-radius: 6px;
            background: white;
            color: var(--primary);
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.85rem;
        }

        .details-button:hover {
            background: var(--primary);
            color: white;
        }

        /* Device Details Modal */
        .device-info-section {
            margin-bottom: 30px;
        }

        .device-info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .device-info-item {
            padding: 15px;
            background: var(--light);
            border-radius: 8px;
            border-left: 4px solid var(--primary);
        }

        .device-info-label {
            font-size: 0.8rem;
            color: var(--gray);
            margin-bottom: 5px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .device-info-value {
            font-size: 1rem;
            color: var(--dark);
            font-weight: 600;
        }

        .device-traffic-section h4 {
            margin-bottom: 15px;
            color: var(--dark);
        }

        .device-traffic-table-container {
            background: white;
            border-radius: 8px;
            border: 1px solid var(--border);
            overflow: hidden;
        }

        /* Hostnames manager */
        .hostnames-container { padding: 16px; }
        .hn-columns { display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 16px; }
        .hn-panel { background: #fff; border: 1px solid var(--border); border-radius: 12px; overflow: hidden; }
        .hn-panel-header { display: flex; align-items: center; justify-content: space-between; padding: 12px 16px; background: var(--light); border-bottom: 1px solid var(--border); }
        .hn-panel-body { padding: 12px 16px; max-height: 420px; overflow: auto; }
        .hn-list { list-style: none; margin: 0; padding: 0; }
        .hn-item { display: flex; align-items: center; justify-content: space-between; padding: 8px 0; border-bottom: 1px dashed var(--border); }
        .hn-item:last-child { border-bottom: none; }
        .hn-item-title { font-weight: 600; color: var(--dark); }
        .hn-item-sub { font-size: 0.85rem; color: var(--gray); }
        .hn-actions .btn { border: 1px solid var(--border); background: #fff; color: var(--gray); padding: 6px 10px; border-radius: 6px; cursor: pointer; }
        .hn-actions .btn:hover { border-color: var(--primary); color: var(--primary); }
        .btn-small { font-size: 0.85rem; }

        /* Device Modal Styles */
        .device-modal-content {
            max-width: 90vw;
            width: 1200px;
        }

        .device-name-edit {
            display: flex;
            align-items: center;
            gap: 10px;
            flex: 1;
        }

        .device-name-edit input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 1.1rem;
            font-weight: 600;
        }

        .device-name-edit input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .clear-name-btn {
            padding: 4px 8px;
            border: 1px solid var(--border);
            border-radius: 4px;
            background: white;
            color: var(--gray);
            cursor: pointer;
            font-size: 1.2rem;
            line-height: 1;
            transition: all 0.3s ease;
        }

        .clear-name-btn:hover {
            background: var(--danger);
            color: white;
            border-color: var(--danger);
        }

        .device-time-filters {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 15px;
            background: var(--light);
            border-radius: 8px;
        }

        .device-time-filters .time-filter-tabs {
            display: flex;
            gap: 5px;
        }

        .device-time-filters .time-tab {
            padding: 6px 12px;
            border: 1px solid var(--border);
            border-radius: 6px;
            background: white;
            color: var(--gray);
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }

        .device-time-filters .time-tab.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .device-time-filters .time-tab:hover:not(.active) {
            border-color: var(--primary);
            color: var(--primary);
        }

        .device-alert-section {
            display: flex;
            align-items: center;
        }

        .device-alert-section .alert-badge {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 6px 12px;
            border: 1px solid var(--border);
            border-radius: 6px;
            background: white;
            color: var(--gray);
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }

        .device-alert-section .alert-badge.active {
            background: var(--warning);
            color: white;
            border-color: var(--warning);
        }

        .device-alert-section .alert-badge:hover:not(.active) {
            border-color: var(--warning);
            color: var(--warning);
        }

        .device-traffic-section h4 {
            margin: 0 0 15px 0;
            color: var(--dark);
        }

        /* Device Expander Styles */
        .device-expander {
            background: var(--light);
            border-radius: 8px;
            margin-top: 10px;
            overflow: hidden;
        }

        .device-expander-content {
            padding: 20px;
        }

        .device-name-edit-section {
            margin-bottom: 20px;
            padding: 15px;
            background: white;
            border-radius: 8px;
            border: 1px solid var(--border);
        }

        .device-name-edit-section .device-name-edit {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .device-name-edit-section .device-name-edit input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 1.1rem;
            font-weight: 600;
        }

        .device-name-edit-section .device-name-edit input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .device-name-edit-section .clear-name-btn {
            padding: 4px 8px;
            border: 1px solid var(--border);
            border-radius: 4px;
            background: white;
            color: var(--gray);
            cursor: pointer;
            font-size: 1.2rem;
            line-height: 1;
            transition: all 0.3s ease;
        }

        .device-name-edit-section .clear-name-btn:hover {
            background: var(--danger);
            color: white;
            border-color: var(--danger);
        }

        @media (max-width: 768px) {
            .filter-row {
                flex-direction: column;
                flex-wrap: wrap;
            }
            
            .filter-group {
                min-width: unset;
                flex: none;
            }
            
            .traffic-table {
                font-size: 0.8rem;
            }
            
            .traffic-table th,
            .traffic-table td {
                padding: 8px 4px;
            }
        }

        /* Bottom Action Button */
        .bottom-action {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            border: none;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
            transition: all 0.3s ease;
            z-index: 1000;
        }

        .bottom-action:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 16px rgba(102, 126, 234, 0.6);
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .profiles-grid {
                grid-template-columns: 1fr;
            }
            
            .live-profiles-grid {
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            }
            
            .sidebar {
            width: 100%;
                left: -100%;
            }
            
            .main-content.sidebar-open {
                margin-left: 0;
            }
            
            .bottom-action {
                bottom: 20px;
                right: 20px;
            }
        }

        /* Loading Spinner */
        .spinner {
            border: 3px solid var(--border);
            border-top: 3px solid var(--primary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 2rem auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 16px;
            max-width: 400px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            animation: modalSlideIn 0.3s ease;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            padding: 24px 24px 0;
            text-align: center;
            position: relative;
        }

        .modal-close {
            position: absolute;
            top: 20px;
            right: 20px;
            background: none;
            border: none;
            font-size: 24px;
            color: var(--gray);
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            transition: all 0.3s ease;
        }

        .modal-close:hover {
            background: var(--light);
            color: var(--dark);
        }

        .modal-title {
            font-size: 20px;
            font-weight: 700;
            color: var(--dark);
            margin-bottom: 8px;
        }

        .modal-subtitle {
            font-size: 14px;
            color: var(--gray);
            margin-bottom: 24px;
        }

        .modal-body {
            padding: 0 24px 24px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--dark);
        }

        .form-control {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
        }

        .file-upload {
            position: relative;
            display: inline-block;
            width: 100%;
        }

        .file-upload-input {
            position: absolute;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }

        .file-upload-label {
            display: flex;
                flex-direction: column;
            align-items: center;
            padding: 20px;
            border: 2px dashed var(--border);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .file-upload-label:hover {
            border-color: var(--primary);
            background: rgba(102, 126, 234, 0.05);
        }

        .file-upload-label.has-image {
            border: 2px solid var(--primary);
            background: rgba(102, 126, 234, 0.05);
        }

        .file-upload-icon {
            width: 48px;
            height: 48px;
            background: var(--light);
            border-radius: 50%;
            display: flex;
            align-items: center;
                justify-content: center;
            margin-bottom: 12px;
            font-size: 24px;
            color: var(--gray);
        }

        .file-upload-text {
            font-size: 14px;
            color: var(--gray);
        }

        .preview-image {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            object-fit: cover;
            margin: 0 auto 8px;
            display: block;
        }

        .change-image-text {
            font-size: 12px;
            color: var(--primary);
            font-weight: 500;
        }

        .modal-footer {
            padding: 0 24px 24px;
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-secondary {
            background: var(--gray);
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6c7d;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
        }

        /* Hidden sections */
        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }
    </style>
</head>
<body>
    <!-- Status Bar -->
            <div class="status-bar">
        <div class="app-title">NetScanner</div>
                </div>

    <!-- Hamburger Menu -->
    <div class="hamburger" id="hamburger" onclick="toggleSidebar()">
        <div class="hamburger-line"></div>
        <div class="hamburger-line"></div>
        <div class="hamburger-line"></div>
                </div>

    <!-- Overlay for mobile -->
    <div class="overlay" id="overlay" onclick="closeSidebar()"></div>

    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
        <nav>
            <ul class="nav-menu">
                <li class="nav-item">
                    <a href="#home" class="nav-link active" onclick="showSection('home')">
                        <svg class="nav-icon" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M3 13h8V3H3v10zm0 8h8v-6H3v6zm10 0h8V11h-8v10zm0-18v6h8V3h-8z"/>
                        </svg>
                        <span>Home</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#live" class="nav-link" onclick="showSection('live')">
                        <svg class="nav-icon" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M11 17c0 .55.45 1 1 1s1-.45 1-1-.45-1-1-1-1 .45-1 1zm0-14v4h2V5.08c3.39.49 6 3.39 6 6.92 0 3.87-3.13 7-7 7s-7-3.13-7-7c0-1.68.59-3.22 1.58-4.42L12 13l1.41-1.41-6.8-6.8v.02C4.42 6.45 3 9.05 3 12c0 4.97 4.02 9 9 9 4.97 0 9-4.03 9-9s-4.03-9-9-9h-1zm7 9c0-.55-.45-1-1-1s-1 .45-1 1 .45 1 1 1 1-.45 1-1zM6 12c0 .55.45 1 1 1s1-.45 1-1-.45-1-1-1-1 .45-1 1z"/>
                        </svg>
                        <span>Live</span>
                    </a>
                </li>
                
                <li class="nav-item">
                    <a href="#devices" class="nav-link" onclick="showSection('devices')">
                        <svg class="nav-icon" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M17 1.01L7 1c-1.1 0-2 .9-2 2v18c0 1.1.9 2 2 2h10c1.1 0 2-.9 2-2V3c0-1.1-.9-1.99-2-1.99zM17 19H7V5h10v14z"/>
                        </svg>
                        <span>Devices</span>
                        <span class="badge" id="devices-badge" style="display:none;">0</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#rules" class="nav-link" onclick="showSection('rules')">
                        <svg class="nav-icon" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M12 2L2 7v10l10 5 10-5V7l-10-5zm0 3.09L18.26 7 12 10.91 5.74 7 12 5.09zM4 8.82l7 3.89v6.97L4 15.78V8.82zm16 6.96l-7 3.9v-6.97l7-3.89v6.96z"/>
                        </svg>
                        <span>Rules</span>
                        <span class="badge" id="rules-badge" style="display:none;">0</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#settings" class="nav-link" onclick="showSection('settings')">
                        <svg class="nav-icon" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M19.14,12.94a7.43,7.43,0,0,0,.06-1,7.43,7.43,0,0,0-.06-1l2.11-1.65a.5.5,0,0,0,.12-.64l-2-3.46a.5.5,0,0,0-.6-.22l-2.49,1a7.28,7.28,0,0,0-1.73-1L14.5,2.5a.5.5,0,0,0-.5-.5H10a.5.5,0,0,0-.5.5L9,4.97a7.28,7.28,0,0,0-1.73,1l-2.49-1a.5.5,0,0,0-.6.22l-2,3.46a.5.5,0,0,0,.12.64L4.38,9.94a7.43,7.43,0,0,0-.06,1,7.43,7.43,0,0,0,.06,1L2.27,13.59a.5.5,0,0,0-.12.64l2,3.46a.5.5,0,0,0,.6.22l2.49-1a7.28,7.28,0,0,0,1.73,1l.5,2.47a.5.5,0,0,0,.5.5h4a.5.5,0,0,0,.5-.5l.5-2.47a7.28,7.28,0,0,0,1.73-1l2.49,1a.5.5,0,0,0,.6-.22l2-3.46a.5.5,0,0,0-.12-.64Z"/>
                        </svg>
                        <span>Settings</span>
                    </a>
                </li>
            </ul>
        </nav>
    </aside>

    <!-- Main Content -->
    <main class="main-content" id="main-content">
        <div id="demo-banner" style="display:none;background:#ffe5e5;color:#b00020;padding:8px 16px;text-align:center;font-weight:700;letter-spacing:0.5px;">DEMO MODE — Showing sample data</div>
        <div class="dashboard-content">
            <!-- Home Section -->
            <div id="home-section" class="tab-content active">
                <!-- Profile Cards -->
                <div class="profiles-grid" id="profiles-grid">
                    <!-- Profile cards will be inserted here -->
                </div>

                <!-- Add Profile Button removed - profiles managed in Profiles tab -->
        </div>

            <!-- Profile Detail Section -->
            <div id="profile-detail-section" class="profile-detail tab-content">
                <div class="profile-detail-header">
                    <button class="back-button" onclick="showDashboard()">←</button>
                    <div class="profile-detail-title">
                        <div id="profile-detail-avatar"></div>
                        <span id="profile-detail-name">Profile Name</span>
                    </div>
                </div>
                <div class="profile-detail-content">
                    <!-- Connected Devices Section -->
                    <div class="collapsible-section">
                        <div class="collapsible-header" onclick="toggleCollapsible('devices')">
                            <div class="collapsible-title">
                                <span>📱</span>
                                <span>Connected Devices</span>
                                <div class="collapsible-count" id="devices-count">0</div>
                            </div>
                            <div class="collapsible-icon" id="devices-icon">▼</div>
                        </div>
                        <div class="collapsible-content" id="devices-content">
                            <div class="collapsible-body">
                                <div class="device-grid" id="devices-grid">
                                    <!-- Device cards will be inserted here -->
                                </div>
        </div>
            </div>
        </div>

                    <!-- Active Today Section -->
                    <div class="collapsible-section">
                        <div class="collapsible-header" onclick="toggleCollapsible('active')">
                            <div class="collapsible-title">
                                <span>⏱️</span>
                                <span>Active Today</span>
                                <div class="collapsible-total" id="active-total">0h 0m</div>
                            </div>
                            <div class="collapsible-icon" id="active-icon">▼</div>
                        </div>
                        <div class="collapsible-content" id="active-content">
                            <div class="collapsible-body">
                                <div id="app-categories">
                                    <!-- App categories will be inserted here -->
                                </div>
                            </div>
                </div>
            </div>

                    <!-- Alerts Section -->
                    <div class="collapsible-section">
                        <div class="collapsible-header" onclick="toggleCollapsible('alerts')">
                            <div class="collapsible-title">
                                <span>🚨</span>
                                <span>Alerts</span>
                                <div class="collapsible-badge" id="alerts-badge" style="display: none;">0</div>
                            </div>
                            <div class="collapsible-icon" id="alerts-icon">▼</div>
                        </div>
                        <div class="collapsible-content" id="alerts-content">
                            <div class="collapsible-body">
                                <div class="alert-actions">
                                    <button class="alert-action-btn" onclick="clearAllAlerts()" title="Clear All Alerts">🗑️</button>
                                </div>
                                <div id="alerts-list">
                                    <!-- Alert items will be inserted here -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Other sections (Live, Profiles, Devices, Hostnames) -->
            <div id="live-section" class="tab-content">
                <!-- Profile Cards (Small) -->
                <div class="live-profiles-section">
                    <h3>Family Members</h3>
                    <div class="live-profiles-grid" id="live-profiles-grid">
                        <!-- Profile cards will be populated here -->
                </div>
            </div>

                <!-- Category and App Filters -->
                <div class="live-filters">
                    <div class="filter-section">
                        <div class="filter-row">
                            <div class="filter-group">
                                <h4>Categories</h4>
                                <div class="category-filters" id="category-filters">
                                    <!-- Category filters will be populated here -->
                                </div>
                            </div>
                            <div class="filter-group">
                                <h4>Applications</h4>
                                <div class="app-filters" id="app-filters">
                                    <!-- App filters will be populated here -->
                                </div>
                            </div>
                </div>
            </div>
        </div>

                <!-- Time Filter and Active Filters -->
                <div class="live-traffic-section">
                    <div class="traffic-header">
                        <div class="traffic-title-section">
                            <h3>Live Network Traffic</h3>
                            <div class="alert-badge" id="live-alert-badge" onclick="toggleAlertFilter()">
                                <span class="alert-icon">⚠️</span>
                                <span class="alert-count">0</span>
                            </div>
                        </div>
                        <div class="traffic-controls">
                            <div class="time-filter-section">
                                <h4>Time Range</h4>
                                <div class="time-filter-tabs" id="time-filter-tabs">
                                    <div class="time-tab active" data-range="15min">Last 15 min</div>
                                    <div class="time-tab" data-range="1hour">Last 1 hour</div>
                                    <div class="time-tab" data-range="2hours">Last 2 hours</div>
                                    <div class="time-tab" data-range="daily">Today</div>
                                </div>
                            </div>
                            <div class="active-filters-section" id="active-filters-section" style="display: none;">
                                <h4>Active Filters</h4>
                                <div class="active-filters" id="active-filters">
                                    <!-- Active filters will be displayed here -->
                                </div>
            </div>
        </div>
    </div>
                    
                    <div class="traffic-table-container">
                        <table class="traffic-table" id="traffic-table">
                            <thead>
                                <tr>
                                    <th class="sortable" data-sort="device">Device <span class="sort-icon">↕</span></th>
                                    <th class="sortable" data-sort="category">Category <span class="sort-icon">↕</span></th>
                                    <th class="sortable" data-sort="accessing">Accessing <span class="sort-icon">↕</span></th>
                                    <th class="sortable" data-sort="duration">Duration <span class="sort-icon">↕</span></th>
                                    <th class="sortable" data-sort="data">Data <span class="sort-icon">↕</span></th>
                                    <th class="sortable" data-sort="status">Status <span class="sort-icon">↕</span></th>
                                </tr>
                            </thead>
                            <tbody id="traffic-tbody">
                                <!-- Traffic rows will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="profiles-section" class="tab-content">
                <div style="text-align: center; padding: 40px; color: var(--gray);">
                    <h2>Profile Management</h2>
                    <p>Manage family member profiles here</p>
                </div>
            </div>

            <div id="devices-section" class="tab-content">
                <div class="devices-header">
                    <h2>Network Devices</h2>
                    <div class="devices-controls">
                        <button class="refresh-button" onclick="refreshDevices()">
                            <span class="refresh-icon">🔄</span>
                            Refresh
                        </button>
                        <button class="scan-button" onclick="scanNetwork()">
                            <span class="scan-icon">🔍</span>
                            Scan Network
                        </button>
                    </div>
                </div>

                <!-- Devices Table -->
                <div class="devices-table-container">
                    <table class="traffic-table" id="devices-table">
                        <thead>
                            <tr>
                                <th class="sortable" data-sort="name">Device <span class="sort-icon">↕</span></th>
                                <th class="sortable" data-sort="manufacturer">Manufacturer <span class="sort-icon">↕</span></th>
                                <th class="sortable" data-sort="status">Status <span class="sort-icon">↕</span></th>
                            </tr>
                        </thead>
                        <tbody id="devices-table-body">
                            <!-- Devices will be loaded here -->
                        </tbody>
                    </table>
                </div>

                <!-- Device Expander (hidden by default) -->
                <div id="device-expander" class="device-expander" style="display: none;">
                    <div class="device-expander-content">
                        <!-- Device Name Editing -->
                        <div class="device-name-edit-section">
                            <div class="device-name-edit">
                                <input type="text" id="device-friendly-name" placeholder="Enter friendly name..." 
                                       onblur="saveDeviceName()" onkeypress="handleDeviceNameKeypress(event)">
                                <button class="clear-name-btn" onclick="clearDeviceName()" title="Clear name">×</button>
                            </div>
                        </div>

                        <!-- Time Range Filters -->
                        <div class="device-time-filters">
                            <div class="time-filter-tabs">
                                <button class="time-tab active" onclick="setDeviceTimeRange('15min')">Last 15 min</button>
                                <button class="time-tab" onclick="setDeviceTimeRange('1hour')">1 hour</button>
                                <button class="time-tab" onclick="setDeviceTimeRange('2hours')">2 hours</button>
                                <button class="time-tab" onclick="setDeviceTimeRange('daily')">Today</button>
                            </div>
                            <div class="device-alert-section">
                                <button class="alert-badge" id="device-alert-badge" onclick="toggleDeviceAlertFilter()">
                                    <span class="alert-icon">⚠️</span>
                                    <span class="alert-count">0</span>
                                </button>
                            </div>
                        </div>

                        <!-- Live Network Traffic Table -->
                        <div class="device-traffic-section">
                            <div class="traffic-header">
                                <div class="traffic-title-section">
                                    <h4>Live Network Traffic</h4>
                                </div>
                            </div>
                            <div class="device-traffic-table-container">
                                <table class="traffic-table" id="device-traffic-table">
                                    <thead>
                                        <tr>
                                            <th onclick="sortDeviceTrafficTable('device')" class="sortable">
                                                Device <span class="sort-indicator"></span>
                                            </th>
                                            <th onclick="sortDeviceTrafficTable('category')" class="sortable">
                                                Category <span class="sort-indicator"></span>
                                            </th>
                                            <th onclick="sortDeviceTrafficTable('app')" class="sortable">
                                                Accessing <span class="sort-indicator"></span>
                                            </th>
                                            <th onclick="sortDeviceTrafficTable('duration')" class="sortable">
                                                Duration <span class="sort-indicator"></span>
                                            </th>
                                            <th onclick="sortDeviceTrafficTable('data')" class="sortable">
                                                Data <span class="sort-indicator"></span>
                                            </th>
                                            <th onclick="sortDeviceTrafficTable('status')" class="sortable">
                                                Status <span class="sort-indicator"></span>
                                            </th>
                                        </tr>
                                    </thead>
                                    <tbody id="device-traffic-table-body">
                                        <!-- Traffic sessions will be loaded here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="rules-section" class="tab-content">
                <div class="hostnames-container">
                    <div class="hn-columns">
                        <!-- Categories -->
                        <section class="hn-panel">
                            <div class="hn-panel-header">
                                <h3>Categories</h3>
                                <div class="hn-actions">
                                    <button class="btn btn-small" onclick="showAddCategory()">+ Category</button>
                                </div>
                            </div>
                            <div class="hn-panel-body">
                                <ul id="hn-categories" class="hn-list"></ul>
                            </div>
                        </section>

                        <!-- Apps/Sites -->
                        <section class="hn-panel">
                            <div class="hn-panel-header">
                                <h3>Apps & Sites</h3>
                                <div class="hn-actions">
                                    <button class="btn btn-small" onclick="showAddApp()">+ App/Site</button>
                                </div>
                            </div>
                            <div class="hn-panel-body">
                                <ul id="hn-apps" class="hn-list"></ul>
                            </div>
                        </section>

                        <!-- Match Rules -->
                        <section class="hn-panel">
                            <div class="hn-panel-header">
                                <h3>Match Rules</h3>
                                <div class="hn-actions">
                                    <button class="btn btn-small" onclick="showAddRule()">+ Rule</button>
                                </div>
                            </div>
                            <div class="hn-panel-body">
                                <ul id="hn-rules" class="hn-list"></ul>
                            </div>
                        </section>
                    </div>
                </div>
            </div>

            <div id="settings-section" class="tab-content">
                <div class="hostnames-container">
                    <div class="hn-panel">
                        <div class="hn-panel-header">
                            <h3>Session & Classification Settings</h3>
                        </div>
                        <div class="hn-panel-body">
                            <div class="form-group" style="margin-bottom:12px;">
                                <label>Session idle close threshold (seconds)</label>
                                <input id="set-idle" type="number" min="10" step="5" value="90" style="width:140px;">
                                <span class="hint">Close a session if no packets seen after this idle period.</span>
                            </div>
                            <div class="form-group" style="margin-bottom:12px;">
                                <label>nDPI usage</label>
                                <select id="set-ndpi" style="width:180px;">
                                    <option value="off">Off</option>
                                    <option value="fallback">Fallback (only if no rule found)</option>
                                    <option value="on">On (always consult)</option>
                                </select>
                            </div>
                            <button class="btn" onclick="saveSettings()">Save</button>
                            <span id="set-status" style="margin-left:10px;color:var(--gray);"></span>
                        </div>
                    </div>
                </div>
            </div>
    </div>
    </main>

    <!-- Add Profile Modal -->
    <div class="modal" id="add-profile-modal">
        <div class="modal-content">
            <div class="modal-header">
                <button class="modal-close" onclick="closeAddProfileModal()">×</button>
                <h3 class="modal-title">Add Family Member</h3>
                <p class="modal-subtitle">Create a profile for a family member</p>
            </div>
            <div class="modal-body">
                <form id="add-profile-form">
                    <div class="form-group">
                        <label class="form-label" for="profile-name">Name</label>
                        <input type="text" class="form-control" id="profile-name" placeholder="Enter family member's name" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Profile Picture</label>
                        <div class="file-upload">
                            <input type="file" class="file-upload-input" id="profile-picture" accept="image/*" onchange="previewImage(this)">
                            <label for="profile-picture" class="file-upload-label">
                                <div class="file-upload-icon">📷</div>
                                <div class="file-upload-text">Click to upload a photo</div>
                            </label>
                            <img id="image-preview" class="preview-image" style="display: none;">
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeAddProfileModal()">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveProfile()">Add Member</button>
            </div>
        </div>
    </div>

    <!-- Bottom Action Button -->
    <button class="bottom-action" onclick="showAddProfileModal()" title="Add Family Member" id="bottom-add-button" style="display: none;">
        +
    </button>

    <script>
        // Global variables
        let currentSection = 'home';
        let sidebarOpen = false;
        let refreshInterval = null;

        // Live Tab Functionality
        let liveData = {
            // SAMPLE DATA - Replace with real API calls
            profiles: [
                { id: 'profile_1', name: 'John Doe', picture: null },
                { id: 'profile_2', name: 'Jane Smith', picture: null },
                { id: 'profile_3', name: 'Kids', picture: null }
            ],
            categories: [
                { id: 'social', name: 'Social Media', count: 15 },
                { id: 'gaming', name: 'Gaming', count: 8 },
                { id: 'work', name: 'Work', count: 12 },
                { id: 'education', name: 'Education', count: 6 },
                { id: 'entertainment', name: 'Entertainment', count: 20 }
            ],
            apps: [
                { id: 'instagram', name: 'Instagram', category: 'social', url: 'instagram.com' },
                { id: 'facebook', name: 'Facebook', category: 'social', url: 'facebook.com' },
                { id: 'playstation', name: 'PlayStation Network', category: 'gaming', url: 'playstation.com' },
                { id: 'netflix', name: 'Netflix', category: 'entertainment', url: 'netflix.com' },
                { id: 'youtube', name: 'YouTube', category: 'entertainment', url: 'youtube.com' },
                { id: 'slack', name: 'Slack', category: 'work', url: 'slack.com' }
            ],
            // SAMPLE SESSIONS - Replace with real aggregated session data
            sessions: [],
            filters: {
                profiles: [],
                categories: [],
                apps: [],
                alerts: false,
                timeRange: '15min'
            },
            activeFilters: [],
            sortColumn: null,
            sortDirection: 'asc',
            alertCount: 0
        };

        // Initialize Live tab data - SAMPLE DATA ONLY
        async function initializeLiveData() {
            // Try real API first
            let usedDemo = false;
            try {
                const res = await fetch('/api/live/sessions?hours=1');
                const data = await res.json();
                if (data && Array.isArray(data.sessions) && data.sessions.length > 0) {
                    // Map to current structure
                    liveData.sessions = data.sessions.map(s => ({
                        device: s.device,
                        deviceIp: s.deviceIp,
                        category: s.category,
                        categoryId: s.categoryId,
                        app: s.app,
                        appId: s.appId,
                        startTime: s.startTime,
                        lastSeen: s.lastSeen,
                        duration: s.duration,
                        dataBytes: s.dataBytes,
                        isActive: s.isActive,
                        hostname: s.hostname || null,
                        dstIp: s.dstIp || null,
                    }));
                } else {
                    usedDemo = true;
                }
            } catch (e) {
                usedDemo = true;
            }

            if (usedDemo) {
                liveData.sessions = generateSampleSessions();
            }

            // Banner
            const banner = document.getElementById('demo-banner');
            if (banner) banner.style.display = usedDemo ? 'block' : 'none';

            // Load all components
            loadLiveProfiles();
            loadTimeFilters();
            loadCategoryFilters();
            loadAppFilters();
            loadSessionsTable();
            updateAlertBadge();
        }

        // Generate sample session data - SAMPLE DATA ONLY (100 rows with random dates)
        function generateSampleSessions() {
            const sessions = [];
            const devices = [
                { name: 'iPhone 12', ip: '192.168.1.100', profile: 'profile_1' },
                { name: 'MacBook Pro', ip: '192.168.1.101', profile: 'profile_2' },
                { name: 'PlayStation 5', ip: '192.168.1.102', profile: 'profile_3' },
                { name: 'iPad', ip: '192.168.1.103', profile: 'profile_1' },
                { name: 'Samsung Galaxy', ip: '192.168.1.104', profile: 'profile_2' },
                { name: 'Dell Laptop', ip: '192.168.1.105', profile: 'profile_3' },
                { name: 'Xbox One', ip: '192.168.1.106', profile: 'profile_1' },
                { name: 'Surface Pro', ip: '192.168.1.107', profile: 'profile_2' }
            ];

            const apps = liveData.apps;
            const categories = liveData.categories;
            
            // Generate 100 sessions with random dates over the last 7 days
            for (let i = 0; i < 100; i++) {
                const device = devices[Math.floor(Math.random() * devices.length)];
                const app = apps[Math.floor(Math.random() * apps.length)];
                const category = categories.find(c => c.id === app.category);
                
                // Random time within last 7 days
                const randomDays = Math.random() * 7;
                const randomHours = Math.random() * 24;
                const randomMinutes = Math.random() * 60;
                const startTime = new Date(Date.now() - (randomDays * 24 * 60 * 60 * 1000) - (randomHours * 60 * 60 * 1000) - (randomMinutes * 60 * 1000));
                
                const duration = Math.floor(Math.random() * 120) + 1; // 1-120 minutes
                const isActive = Math.random() > 0.4; // 60% chance of being active
                const dataBytes = Math.floor(Math.random() * 100 * 1024 * 1024); // Up to 100MB
                
                sessions.push({
                    id: `session_${i}`,
                    device: device.name,
                    deviceIp: device.ip,
                    profile: device.profile,
                    category: category.name,
                    categoryId: category.id,
                    app: app.name,
                    appId: app.id,
                    url: app.url,
                    startTime: startTime,
                    duration: duration,
                    isActive: isActive,
                    dataBytes: dataBytes,
                    lastSeen: isActive ? new Date() : new Date(startTime.getTime() + duration * 60000),
                    hasAlert: Math.random() > 0.85 // 15% chance of having an alert
                });
            }
            
            // Sort by most recent activity first
            return sessions.sort((a, b) => b.lastSeen - a.lastSeen);
        }

        // Load Live tab data
        function loadLiveData() {
            initializeLiveData();
        }

        // Time filter functions
        function loadTimeFilters() {
            console.log('Loading time filters...');
            const tabs = document.querySelectorAll('.time-tab');
            console.log('Found time tabs:', tabs.length);
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    console.log('Time tab clicked:', tab.getAttribute('data-range'));
                    // Remove active class from all tabs
                    tabs.forEach(t => t.classList.remove('active'));
                    // Add active class to clicked tab
                    tab.classList.add('active');
                    
                    // Update filter
                    liveData.filters.timeRange = tab.getAttribute('data-range');
                    console.log('Updated time range to:', liveData.filters.timeRange);
                    loadSessionsTable();
                });
            });
        }

        // Load live profiles (small cards)
        function loadLiveProfiles() {
            console.log('Loading live profiles...', liveData.profiles);
            const container = document.getElementById('live-profiles-grid');
            if (!container) {
                console.error('live-profiles-grid container not found');
                return;
            }
            container.innerHTML = '';
            
            liveData.profiles.forEach(profile => {
                const card = document.createElement('div');
                card.className = 'live-profile-card';
                card.onclick = () => toggleLiveProfileFilter(profile.id);
                
                // Calculate time online for this profile
                const profileSessions = liveData.sessions.filter(s => s.profile === profile.id);
                const totalTime = profileSessions.reduce((sum, s) => sum + s.duration, 0);
                const isOnline = profileSessions.some(s => s.isActive);
                
                card.innerHTML = `
                    <div class="live-profile-avatar">${profile.name.charAt(0)}</div>
                    <div class="live-profile-name">${profile.name}</div>
                    <div class="live-profile-status">
                        <div class="live-status-dot ${isOnline ? '' : 'offline'}"></div>
                        ${isOnline ? 'Online' : 'Offline'}
                    </div>
                    <div class="live-profile-time">${formatDuration(totalTime)}</div>
                `;
                
                container.appendChild(card);
            });
        }

        // Toggle live profile filter
        function toggleLiveProfileFilter(profileId) {
            const index = liveData.filters.profiles.indexOf(profileId);
            if (index > -1) {
                liveData.filters.profiles.splice(index, 1);
                } else {
                liveData.filters.profiles.push(profileId);
            }
            
            // Update UI
            const cards = document.querySelectorAll('.live-profile-card');
            cards.forEach(card => {
                const profile = liveData.profiles.find(p => p.name === card.querySelector('.live-profile-name').textContent);
                if (profile && liveData.filters.profiles.includes(profile.id)) {
                    card.classList.add('selected');
                } else {
                    card.classList.remove('selected');
                }
            });
            
            updateActiveFilters();
            loadSessionsTable();
        }

        function toggleProfileFilter(profileId) {
            const index = liveData.filters.profiles.indexOf(profileId);
            if (index > -1) {
                liveData.filters.profiles.splice(index, 1);
            } else {
                liveData.filters.profiles.push(profileId);
            }
            
            // Update UI
            const chips = document.querySelectorAll('#profile-filters .filter-chip');
            chips.forEach(chip => {
                const profile = liveData.profiles.find(p => p.name === chip.textContent);
                if (profile && liveData.filters.profiles.includes(profile.id)) {
                    chip.classList.add('selected');
                } else {
                    chip.classList.remove('selected');
                }
            });
            
            updateActiveFilters();
            loadSessionsTable();
        }

        // Category filter functions
        function loadCategoryFilters() {
            const container = document.getElementById('category-filters');
            container.innerHTML = '';
            
            liveData.categories.forEach(category => {
                const chip = document.createElement('div');
                chip.className = 'filter-chip';
                chip.innerHTML = `
                    ${category.name}
                    <span class="count">${category.count}</span>
                `;
                chip.onclick = () => toggleCategoryFilter(category.id);
                container.appendChild(chip);
            });
        }

        function toggleCategoryFilter(categoryId) {
            const index = liveData.filters.categories.indexOf(categoryId);
            if (index > -1) {
                liveData.filters.categories.splice(index, 1);
            } else {
                liveData.filters.categories.push(categoryId);
            }
            
            // Update UI
            const chips = document.querySelectorAll('#category-filters .filter-chip');
            chips.forEach(chip => {
                const category = liveData.categories.find(c => c.name === chip.textContent.split(' ')[0]);
                if (category && liveData.filters.categories.includes(category.id)) {
                    chip.classList.add('selected');
                } else {
                    chip.classList.remove('selected');
                }
            });
            
            // Update app filters based on selected categories
            updateAppFilters();
            updateActiveFilters();
            loadSessionsTable();
        }

        // App filter functions
        function loadAppFilters() {
            updateAppFilters();
        }

        function updateAppFilters() {
            const container = document.getElementById('app-filters');
            container.innerHTML = '';
            
            // Filter apps based on selected categories
            let filteredApps = liveData.apps;
            if (liveData.filters.categories.length > 0) {
                filteredApps = liveData.apps.filter(app => 
                    liveData.filters.categories.includes(app.category)
                );
            }
            
            filteredApps.forEach(app => {
                const chip = document.createElement('div');
                chip.className = 'filter-chip';
                chip.textContent = app.name;
                chip.onclick = () => toggleAppFilter(app.id);
                container.appendChild(chip);
            });
        }

        function toggleAppFilter(appId) {
            const index = liveData.filters.apps.indexOf(appId);
            if (index > -1) {
                liveData.filters.apps.splice(index, 1);
                } else {
                liveData.filters.apps.push(appId);
            }
            
            // Update UI
            const chips = document.querySelectorAll('#app-filters .filter-chip');
            chips.forEach(chip => {
                const app = liveData.apps.find(a => a.name === chip.textContent);
                if (app && liveData.filters.apps.includes(app.id)) {
                    chip.classList.add('selected');
                } else {
                    chip.classList.remove('selected');
                }
            });
            
            updateActiveFilters();
            loadSessionsTable();
        }

        // Alert filter function
        function toggleAlertFilter() {
            liveData.filters.alerts = !liveData.filters.alerts;
            const badge = document.getElementById('live-alert-badge');
            if (liveData.filters.alerts) {
                badge.classList.add('filtered');
            } else {
                badge.classList.remove('filtered');
            }
            updateActiveFilters();
            loadSessionsTable();
        }

        // Update active filters display
        function updateActiveFilters() {
            const container = document.getElementById('active-filters');
            const section = document.getElementById('active-filters-section');
            container.innerHTML = '';
            
            liveData.activeFilters = [];
            
            // Add profile filters
            liveData.filters.profiles.forEach(profileId => {
                const profile = liveData.profiles.find(p => p.id === profileId);
                if (profile) {
                    liveData.activeFilters.push({
                        type: 'profile',
                        id: profileId,
                        name: profile.name,
                        remove: () => toggleLiveProfileFilter(profileId)
                    });
                }
            });
            
            // Add category filters
            liveData.filters.categories.forEach(categoryId => {
                const category = liveData.categories.find(c => c.id === categoryId);
                if (category) {
                    liveData.activeFilters.push({
                        type: 'category',
                        id: categoryId,
                        name: category.name,
                        remove: () => toggleCategoryFilter(categoryId)
                    });
                }
            });
            
            // Add app filters
            liveData.filters.apps.forEach(appId => {
                const app = liveData.apps.find(a => a.id === appId);
                if (app) {
                    liveData.activeFilters.push({
                        type: 'app',
                        id: appId,
                        name: app.name,
                        remove: () => toggleAppFilter(appId)
                    });
                }
            });
            
            // Add device filters
            liveData.filters.devices.forEach(deviceName => {
                liveData.activeFilters.push({
                    type: 'device',
                    id: deviceName,
                    name: deviceName,
                    remove: () => removeDeviceFilter(deviceName)
                });
            });
            
            // Add duration filters
            liveData.filters.durations.forEach(duration => {
                liveData.activeFilters.push({
                    type: 'duration',
                    id: duration,
                    name: formatDuration(duration),
                    remove: () => removeDurationFilter(duration)
                });
            });
            
            // Add data range filters
            liveData.filters.dataRanges.forEach(dataRange => {
                liveData.activeFilters.push({
                    type: 'data',
                    id: dataRange,
                    name: formatDataBytes(dataRange),
                    remove: () => removeDataRangeFilter(dataRange)
                });
            });
            
            // Add status filters
            liveData.filters.statuses.forEach(status => {
                liveData.activeFilters.push({
                    type: 'status',
                    id: status,
                    name: status ? 'Active' : 'Inactive',
                    remove: () => removeStatusFilter(status)
                });
            });
            
            // Note: Alerts are not shown in active filters list, but are applied as filter
            
            // Render active filters
            liveData.activeFilters.forEach(filter => {
                const filterDiv = document.createElement('div');
                filterDiv.className = 'active-filter';
                filterDiv.innerHTML = `
                    ${filter.name}
                    <span class="remove" onclick="removeFilter('${filter.type}', '${filter.id}')">×</span>
                `;
                container.appendChild(filterDiv);
            });
            
            // Show/hide section based on active filters
            section.style.display = liveData.activeFilters.length > 0 ? 'block' : 'none';
        }

        // Remove filter function for X button
        function removeFilter(type, id) {
            switch (type) {
                case 'profile':
                    toggleLiveProfileFilter(id);
                    break;
                case 'category':
                    toggleCategoryFilter(id);
                    break;
                case 'app':
                    toggleAppFilter(id);
                    break;
                case 'device':
                    removeDeviceFilter(id);
                    break;
                case 'duration':
                    removeDurationFilter(id);
                    break;
                case 'data':
                    removeDataRangeFilter(id);
                    break;
                case 'status':
                    removeStatusFilter(id);
                    break;
            }
        }

        // Remove device filter
        function removeDeviceFilter(deviceName) {
            const index = liveData.filters.devices.indexOf(deviceName);
            if (index > -1) {
                liveData.filters.devices.splice(index, 1);
                updateActiveFilters();
                loadSessionsTable();
            }
        }

        // Remove duration filter
        function removeDurationFilter(duration) {
            const index = liveData.filters.durations.indexOf(duration);
            if (index > -1) {
                liveData.filters.durations.splice(index, 1);
                updateActiveFilters();
                loadSessionsTable();
            }
        }

        // Remove data range filter
        function removeDataRangeFilter(dataRange) {
            const index = liveData.filters.dataRanges.indexOf(dataRange);
            if (index > -1) {
                liveData.filters.dataRanges.splice(index, 1);
                updateActiveFilters();
                loadSessionsTable();
            }
        }

        // Remove status filter
        function removeStatusFilter(status) {
            const index = liveData.filters.statuses.indexOf(status);
            if (index > -1) {
                liveData.filters.statuses.splice(index, 1);
                updateActiveFilters();
                loadSessionsTable();
            }
        }

        // Update alert badge
        function updateAlertBadge() {
            const badge = document.getElementById('live-alert-badge');
            const count = document.querySelector('.alert-count');
            count.textContent = liveData.alertCount;
        }

        // Sessions table functions
        function loadSessionsTable() {
            console.log('Loading sessions table...');
            const tbody = document.getElementById('traffic-tbody');
            if (!tbody) {
                console.error('traffic-tbody not found');
                    return;
                }
            tbody.innerHTML = '';
            
            // Apply time range filter
            let filteredSessions = liveData.sessions.filter(session => {
                const now = new Date();
                const sessionTime = session.lastSeen;
                const timeDiff = now - sessionTime;
                
                switch (liveData.filters.timeRange) {
                    case '15min':
                        return timeDiff <= 15 * 60 * 1000;
                    case '1hour':
                        return timeDiff <= 60 * 60 * 1000;
                    case '2hours':
                        return timeDiff <= 2 * 60 * 60 * 1000;
                    case 'daily':
                        return timeDiff <= 24 * 60 * 60 * 1000;
                    default:
                        return true;
                }
            });
            
            console.log('Filtered sessions:', filteredSessions.length);
            
            // Apply other filters
            filteredSessions = filteredSessions.filter(session => {
                // Profile filter
                if (liveData.filters.profiles.length > 0 && !liveData.filters.profiles.includes(session.profile)) {
                    return false;
                }
                
                // Category filter
                if (liveData.filters.categories.length > 0 && !liveData.filters.categories.includes(session.categoryId)) {
                    return false;
                }
                
                // App filter
                if (liveData.filters.apps.length > 0 && !liveData.filters.apps.includes(session.appId)) {
                    return false;
                }
                
                // Alert filter
                if (liveData.filters.alerts && !session.hasAlert) {
                    return false;
                }
                
                // Device filter (by IP address)
                if (liveData.filters.devices.length > 0 && !liveData.filters.devices.includes(session.deviceIp)) {
                    return false;
                }
                
                // Duration filter
                if (liveData.filters.durations.length > 0 && !liveData.filters.durations.includes(session.duration)) {
                    return false;
                }
                
                // Data range filter
                if (liveData.filters.dataRanges.length > 0 && !liveData.filters.dataRanges.includes(session.dataBytes)) {
                    return false;
                }
                
                // Status filter
                if (liveData.filters.statuses.length > 0 && !liveData.filters.statuses.includes(session.isActive)) {
                    return false;
                }
                
                return true;
            });
            
            // Apply sorting
            if (liveData.sortColumn) {
                filteredSessions.sort((a, b) => {
                    let aVal = a[liveData.sortColumn];
                    let bVal = b[liveData.sortColumn];
                    
                    if (liveData.sortColumn === 'lastSeen' || liveData.sortColumn === 'startTime') {
                        aVal = new Date(aVal);
                        bVal = new Date(bVal);
                    }
                    
                    if (liveData.sortDirection === 'asc') {
                        return aVal > bVal ? 1 : -1;
                    } else {
                        return aVal < bVal ? 1 : -1;
                    }
                });
            } else {
                // Default sort: active sessions first, then by last seen
                filteredSessions.sort((a, b) => {
                    if (a.isActive !== b.isActive) {
                        return b.isActive - a.isActive; // Active first
                    }
                    return b.lastSeen - a.lastSeen; // Most recent first
                });
            }
            
            // Render rows (with async classification for unknowns)
            filteredSessions.forEach(async session => {
                // If category/app unknown, call classifier (demo check: empty or 'Unknown')
                if (!session.category || !session.app || session.category === 'Uncategorized' || session.app === 'Unknown') {
                    try {
                        const res = await fetch('/api/network/classify', {
                            method: 'POST', headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ hostname: session.hostname || session.domain || '', sni: session.sni || '', ip: session.deviceIp || '' })
                        });
                        const cls = await res.json();
                        session.category = cls.category || session.category;
                        session.app = cls.app || session.app;
                    } catch (e) { console.warn('classify failed', e); }
                }
                const row = createSessionRow(session);
                tbody.appendChild(row);
            });
        }

        function createSessionRow(session) {
            const row = document.createElement('tr');
            const hostOrIp = session.hostname || session.dstIp || session.deviceIp || '';
            const isUnknown = (!session.category || session.category === 'Uncategorized' || !session.app || session.app === 'Unknown');
            const accessingLabel = isUnknown ? (hostOrIp || 'Unknown') : session.app;
            row.innerHTML = `
                <td class="clickable-cell" onclick="filterByValue('device', '${session.deviceIp}')">
                        <div class="device-info">
                        <div class="device-name">${session.device}</div>
                        <div class="device-ip">${session.deviceIp}</div>
                            </div>
                </td>
                <td class="clickable-cell" onclick="filterByValue('category', '${session.categoryId}')">
                    <span class="category-badge category-${session.categoryId}">${session.category}</span>
                </td>
                <td class="clickable-cell" onclick="filterByValue('app', '${session.appId}')">
                    <div class="accessing-info">
                        <div class="accessing-app">${accessingLabel}</div>
                        <div class="accessing-time">${formatTime(session.startTime)}</div>
                        </div>
                </td>
                <td>
                    <div class="duration-info">${formatDuration(session.duration)}</div>
                </td>
                <td>
                    <div class="data-info">${formatDataBytes(session.dataBytes)}</div>
                </td>
                <td class="clickable-cell" onclick="filterByValue('status', '${session.isActive}')">
                    <div class="session-status">
                        <div class="status-dot ${session.isActive ? 'status-active' : 'status-inactive'}"></div>
                        ${session.isActive ? 'Active' : 'Inactive'}
                    </div>
                </td>
            `;
            const qa = document.createElement('td');
            qa.innerHTML = `<div class="quick-actions"><span class="quick-action" onclick="event.stopPropagation(); quickAddRule('${session.app}', '${session.category}', '${session.dstIp || ''}', '${session.hostname || ''}')">Add rule</span></div>`;
            row.appendChild(qa);
            return row;
        }

        function formatDataBytes(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            const value = parseFloat((bytes / Math.pow(k, i)).toFixed(1));
            
            // Special formatting for KB and MB thresholds
            if (i === 1 && value < 0.1) return '< 0.1 KB';
            if (i === 2 && value >= 1024) return '1.0 GB';
            
            return value + ' ' + sizes[i];
        }

        function formatDuration(minutes) {
            if (minutes < 60) {
                return `${minutes}m`;
            }
            const hours = Math.floor(minutes / 60);
            const remainingMinutes = minutes % 60;
            if (remainingMinutes === 0) {
                return `${hours}h`;
            }
            return `${hours}h ${remainingMinutes}m`;
        }

        function formatTime(timestamp) {
            const now = new Date();
            const diff = now - timestamp;
            const minutes = Math.floor(diff / 60000);
            
            if (minutes < 1) return 'Just now';
            if (minutes < 60) return `${minutes}m ago`;
            const hours = Math.floor(minutes / 60);
            if (hours < 24) return `${hours}h ago`;
            return timestamp.toLocaleDateString();
        }

        // Filter by cell value - adds filter when clicking on table cells
        function filterByValue(column, value) {
            console.log(`Adding filter: ${column} = ${value}`);
            
            // Add appropriate filter based on column
            switch (column) {
                case 'device':
                    // Find profile by device name and add to profile filter
                    const session = liveData.sessions.find(s => s.device === value);
                    if (session && !liveData.filters.profiles.includes(session.profile)) {
                        toggleProfileFilter(session.profile);
                    }
                    break;
                case 'category':
                    if (!liveData.filters.categories.includes(value)) {
                        toggleCategoryFilter(value);
                    }
                    break;
                case 'app':
                    if (!liveData.filters.apps.includes(value)) {
                        toggleAppFilter(value);
                    }
                    break;
                case 'status':
                    if (value === 'true' && !liveData.filters.alerts) {
                        toggleAlertFilter();
                    }
                    break;
            }
        }

        // Table sorting with 3-state: unsorted -> asc -> desc -> unsorted
        function sortTable(column) {
            if (liveData.sortColumn === column) {
                if (liveData.sortDirection === 'asc') {
                    liveData.sortDirection = 'desc';
                } else if (liveData.sortDirection === 'desc') {
                    // Third click: unsorted (reset to default)
                    liveData.sortColumn = null;
                    liveData.sortDirection = 'asc';
                }
            } else {
                // First click: ascending
                liveData.sortColumn = column;
                liveData.sortDirection = 'asc';
            }
            
            // Update sort indicators
            document.querySelectorAll('.sort-icon').forEach(icon => {
                icon.textContent = '↕';
            });
            
            if (liveData.sortColumn) {
                const header = document.querySelector(`[data-sort="${liveData.sortColumn}"]`);
                if (header) {
                    const icon = header.querySelector('.sort-icon');
                    icon.textContent = liveData.sortDirection === 'asc' ? '↑' : '↓';
                }
            }
            
            loadSessionsTable();
        }

        // Add click handlers to sortable headers
        function initializeTableSorting() {
            document.querySelectorAll('.sortable').forEach(header => {
                header.addEventListener('click', () => {
                    const column = header.getAttribute('data-sort');
                    sortTable(column);
                });
            });
        }

        // Handle F5 refresh to maintain current section
        function handleRefresh() {
            const saved = localStorage.getItem('currentSection') || 'home';
            // Ensure nav state & content both reflect saved section
            showSection(saved);
        }

        // Resolve section from URL hash or localStorage
        function getSavedSection() {
            let sec = (window.location.hash || '').replace('#', '');
            if (!sec) sec = localStorage.getItem('currentSection') || 'home';
            // Normalize legacy names
            if (sec === 'hostnames') sec = 'rules';
            return sec;
        }

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            // Initial load: prefer hash, then saved section, then home
            const saved = getSavedSection();
            showSection(saved);
            startAutoRefresh();
            initializeTableSorting();
            
            // Handle page refresh
            window.addEventListener('beforeunload', function() {
                localStorage.setItem('currentSection', currentSection);
            });
            
            // Handle page load after refresh (redundant but safe on some browsers)
            window.addEventListener('load', handleRefresh);

            // Keep UI in sync with URL hash when user navigates back/forward
            window.addEventListener('hashchange', function() {
                const sec = getSavedSection();
                if (sec && sec !== currentSection) {
                    showSection(sec);
                }
            });
        });

        // Update time every minute

        // Sidebar functions
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('overlay');
            const hamburger = document.getElementById('hamburger');
            const mainContent = document.getElementById('main-content');

            sidebarOpen = !sidebarOpen;
            
            if (sidebarOpen) {
                sidebar.classList.add('active');
                overlay.classList.add('active');
                hamburger.classList.add('active');
                mainContent.classList.add('sidebar-open');
                } else {
                closeSidebar();
            }
        }

        function closeSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('overlay');
            const hamburger = document.getElementById('hamburger');
            const mainContent = document.getElementById('main-content');

            sidebarOpen = false;
            sidebar.classList.remove('active');
            overlay.classList.remove('active');
            hamburger.classList.remove('active');
            mainContent.classList.remove('sidebar-open');
        }

        // Navigation functions
        function showSection(section) {
            // Hide all sections
            document.querySelectorAll('.tab-content').forEach(el => {
                el.classList.remove('active');
            });
            
            // Remove active class from all nav links
            document.querySelectorAll('.nav-link').forEach(el => {
                el.classList.remove('active');
            });
            
            // Normalize section and show selected; if missing, fallback
            if (section === 'hostnames') section = 'rules';
            let targetSection = document.getElementById(section + '-section');
            if (!targetSection) {
                console.warn('Section not found:', section, 'falling back to home');
                section = 'home';
                targetSection = document.getElementById('home-section');
            }
            if (targetSection && targetSection.classList) {
                targetSection.classList.add('active');
            }
            
            // Add active class to selected nav link
            let linkToActivate = null;
            try {
                const evt = (typeof event !== 'undefined') ? event : null;
                if (evt && evt.currentTarget && typeof evt.currentTarget.matches === 'function' && evt.currentTarget.matches('a.nav-link')) {
                    linkToActivate = evt.currentTarget;
                }
            } catch (_) {}
            if (!linkToActivate) {
                linkToActivate = document.querySelector(`a.nav-link[href="#${section}"]`);
            }
            if (linkToActivate && linkToActivate.classList) {
                linkToActivate.classList.add('active');
            }
            
            currentSection = section;
            
            // Save current section for refresh handling
            localStorage.setItem('currentSection', section);

            // Reflect section in URL hash without causing extra navigation
            const desiredHash = '#' + section;
            if (window.location.hash !== desiredHash) {
                try { history.replaceState(null, '', desiredHash); } catch (_) { window.location.hash = desiredHash; }
            }
            
            // Close sidebar on mobile after selection
            if (window.innerWidth <= 768) {
                closeSidebar();
            }
            
            // Load section-specific data (guard against repeated re-attaches)
            switch(section) {
                case 'home':
                    if (!window.__loaded_home) { window.__loaded_home = true; }
                    loadProfiles();
                    break;
                case 'live':
                    if (!window.__loaded_live) { window.__loaded_live = true; initializeTableSorting(); }
                    loadLiveData();
                    break;
                case 'devices':
                    if (!window.__loaded_devices) { window.__loaded_devices = true; }
                    initializeDevices();
                    break;
                case 'rules':
                    if (!window.__loaded_rules) { window.__loaded_rules = true; }
                    loadHostnamesData();
                    break;
                case 'settings':
                    if (!window.__loaded_settings) { window.__loaded_settings = true; loadSettings(); }
                    loadSettings();
                    break;
            }

            // Ensure add button visibility is only on Home
            if (typeof updateAddButtonVisibility === 'function') {
                updateAddButtonVisibility();
            }
        }

        function showDashboard() {
            document.getElementById('profile-detail-section').classList.remove('active');
            document.getElementById('home-section').classList.add('active');
            // Update button visibility
            updateAddButtonVisibility();
        }

        // Profile functions
        async function loadProfiles() {
            try {
                const response = await fetch('/api/v2/profiles/list');
                const data = await response.json();
                
                const profilesGrid = document.getElementById('profiles-grid');
                if (!profilesGrid) {
                    console.warn('profiles-grid not ready, retrying next frame');
                    return requestAnimationFrame(loadProfiles);
                }
                const addContainer = document.getElementById('add-profile-container');
                const bottomButton = document.getElementById('bottom-add-button');
                
                profilesGrid.innerHTML = '';
                
                if (data.profiles && data.profiles.length > 0) {
                    data.profiles.forEach(profile => {
                        const profileCard = createProfileCard(profile);
                        profilesGrid.appendChild(profileCard);
                    });
                } else {
                    // Show sample data if no profiles exist
                    const sampleProfiles = [
                        { id: 1, name: 'John Doe', picture: null, device_count: 2 },
                        { id: 2, name: 'Jane Smith', picture: null, device_count: 1 },
                        { id: 3, name: 'Kids', picture: null, device_count: 3 }
                    ];
                    
                    sampleProfiles.forEach(profile => {
                        const profileCard = createProfileCard(profile);
                        profilesGrid.appendChild(profileCard);
                    });
                }
                
                // Update button visibility
                updateAddButtonVisibility();
                
                // Update profile card badges
                updateProfileCardBadges();
                
            } catch (error) {
                console.error('Error loading profiles:', error);
                
                // Show sample data on error
                const profilesGrid = document.getElementById('profiles-grid');
                if (!profilesGrid) {
                    console.warn('profiles-grid not ready in catch, retrying next frame');
                    return requestAnimationFrame(loadProfiles);
                }
                const sampleProfiles = [
                    { id: 1, name: 'John Doe', picture: null, device_count: 2 },
                    { id: 2, name: 'Jane Smith', picture: null, device_count: 1 },
                    { id: 3, name: 'Kids', picture: null, device_count: 3 }
                ];
                
                profilesGrid.innerHTML = '';
                sampleProfiles.forEach(profile => {
                    const profileCard = createProfileCard(profile);
                    profilesGrid.appendChild(profileCard);
                });
                
                // Update button visibility on error
                updateAddButtonVisibility();
            }
        }

        function createProfileCard(profile) {
            const card = document.createElement('div');
            card.className = 'profile-card';
            card.onclick = () => showProfileDetail(profile);
            
            const status = getRandomStatus();
            const lastSeen = getRandomLastSeen();
            const lastDevice = getRandomDevice();
            const lastAccessed = getRandomLastAccessed();
            const timeOnline = getRandomTimeOnline();
            const alertCount = Math.floor(Math.random() * 5); // Mock alert count
            
            // Calculate total time from categories (mock data)
            const totalTime = '20h 5m'; // This would be calculated from actual category data
            
            // Create avatar with image or initials
            let avatarContent = '';
            if (profile.picture) {
                avatarContent = `<img src="${profile.picture}" alt="${profile.name}">`;
            } else {
                avatarContent = profile.name.charAt(0).toUpperCase();
            }
            
            card.innerHTML = `
                <div class="profile-alert-badge" ${alertCount > 0 ? 'style="display: block;"' : ''}>${alertCount}</div>
                <div class="profile-header">
                    <div class="profile-avatar">${avatarContent}</div>
                    <div class="profile-info">
                        <h3>${profile.name}</h3>
                        <p>${profile.description || 'Family Member'}</p>
                    </div>
                        </div>
                <div class="profile-stats">
                    <div class="stat-item">
                        <div class="stat-label">Last seen:</div>
                        <div class="stat-value">${lastSeen}</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Last device:</div>
                        <div class="stat-value" style="display: flex; align-items: center; gap: 6px;">
                            <div class="status-dot online" style="width: 6px; height: 6px;"></div>
                            ${lastDevice}
                        </div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Last accessed:</div>
                        <div class="stat-value">${lastAccessed}</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Time online:</div>
                        <div class="stat-value">${totalTime}</div>
                    </div>
                </div>
                <div class="profile-status ${status.class}">${status.text}</div>
            `;
            
            return card;
        }

        function getRandomStatus() {
            const statuses = [
                { class: 'status-online', text: 'Online' },
                { class: 'status-away', text: 'Away' },
                { class: 'status-offline', text: 'Offline' }
            ];
            return statuses[Math.floor(Math.random() * statuses.length)];
        }

        function getRandomLastSeen() {
            const times = ['2 minutes ago', '15 minutes ago', '1 hour ago', '3 hours ago', 'Yesterday', '2 days ago'];
            return times[Math.floor(Math.random() * times.length)];
        }

        function getRandomDevice() {
            const devices = ['iPhone 14', 'MacBook Pro', 'iPad Air', 'Samsung Galaxy', 'Windows PC', 'Android Tablet'];
            return devices[Math.floor(Math.random() * devices.length)];
        }

        function getRandomLastAccessed() {
            const sites = ['YouTube', 'Instagram', 'TikTok', 'Netflix', 'Spotify', 'Gmail', 'Facebook'];
            return sites[Math.floor(Math.random() * sites.length)];
        }

        function getRandomTimeOnline() {
            const times = ['2h 15m', '45m', '6h 30m', '1h 20m', '4h 5m', '30m'];
            return times[Math.floor(Math.random() * times.length)];
        }

        function showProfileDetail(profile) {
            console.log('Showing profile detail for:', profile);
            document.getElementById('home-section').classList.remove('active');
            document.getElementById('profile-detail-section').classList.add('active');
            
            // Update profile header with avatar and name
            const avatarDiv = document.getElementById('profile-detail-avatar');
            const nameSpan = document.getElementById('profile-detail-name');
            
            if (profile.picture) {
                avatarDiv.innerHTML = `<img src="${profile.picture}" alt="${profile.name}" class="profile-detail-avatar">`;
                } else {
                avatarDiv.innerHTML = `<div class="profile-detail-avatar-initials">${profile.name.charAt(0).toUpperCase()}</div>`;
            }
            
            nameSpan.textContent = profile.name;
            
            // Update button visibility
            updateAddButtonVisibility();
            
            // Load profile data
            loadProfileDevices(profile);
            loadProfileActivity(profile);
            loadProfileAlerts(profile);
        }

        // Modal functions
        function showAddProfileModal() {
            document.getElementById('add-profile-modal').classList.add('active');
            // Reset form
            document.getElementById('profile-name').value = '';
            document.getElementById('profile-picture').value = '';
            document.getElementById('image-preview').style.display = 'none';
            
            // Reset file upload UI
            const label = document.querySelector('.file-upload-label');
            const icon = label.querySelector('.file-upload-icon');
            const text = label.querySelector('.file-upload-text');
            icon.style.display = 'flex';
            text.textContent = 'Click to upload a photo';
            text.className = 'file-upload-text';
            label.classList.remove('has-image');
            
            // Update button visibility
            updateAddButtonVisibility();
        }

        function closeAddProfileModal() {
            document.getElementById('add-profile-modal').classList.remove('active');
            // Update button visibility
            updateAddButtonVisibility();
        }

        function previewImage(input) {
            const preview = document.getElementById('image-preview');
            const file = input.files[0];
            const label = input.closest('.file-upload').querySelector('.file-upload-label');
            const icon = label.querySelector('.file-upload-icon');
            const text = label.querySelector('.file-upload-text');
            
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    preview.src = e.target.result;
                    preview.style.display = 'block';
                    
                    // Hide icon and text, show image
                    icon.style.display = 'none';
                    text.textContent = 'Click to change';
                    text.className = 'change-image-text';
                    label.classList.add('has-image');
                };
                reader.readAsDataURL(file);
            } else {
                preview.style.display = 'none';
                icon.style.display = 'flex';
                text.textContent = 'Click to upload a photo';
                text.className = 'file-upload-text';
                label.classList.remove('has-image');
            }
        }

        async function saveProfile() {
            const name = document.getElementById('profile-name').value.trim();
            const pictureFile = document.getElementById('profile-picture').files[0];
            
            if (!name) {
                alert('Please enter a name for the family member');
                    return;
                }
                
            try {
                // Create profile data
                const profileData = {
                    name: name,
                    description: 'Family Member',
                    color: '#3498db',
                    icon: 'user',
                    is_active: true,
                    metadata: {}
                };
                
                // If there's a picture, convert to base64
                if (pictureFile) {
                    const base64 = await fileToBase64(pictureFile);
                    profileData.picture = base64;
                }
                
                // Send to server
                const response = await fetch('/api/v2/profiles/create', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(profileData)
                });
                
                if (response.ok) {
                    closeAddProfileModal();
                    loadProfiles(); // Refresh the profiles list
                } else {
                    const error = await response.json();
                    alert('Error creating profile: ' + (error.error || 'Unknown error'));
                }
                
            } catch (error) {
                console.error('Error saving profile:', error);
                alert('Error creating profile. Please try again.');
            }
        }

        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
            });
        }

        function addProfile() {
            showAddProfileModal();
        }

        // Collapsible section functions
        function toggleCollapsible(section) {
            const content = document.getElementById(section + '-content');
            const icon = document.getElementById(section + '-icon');
            
            if (content.classList.contains('expanded')) {
                content.classList.remove('expanded');
                icon.classList.remove('expanded');
            } else {
                content.classList.add('expanded');
                icon.classList.add('expanded');
            }
        }

        // Profile data loading functions
        function loadProfileDevices(profile) {
            console.log('Loading profile devices for:', profile);
            const devicesGrid = document.getElementById('devices-grid');
            const devicesCount = document.getElementById('devices-count');
            
            if (!devicesGrid || !devicesCount) {
                console.error('Required elements not found:', { devicesGrid, devicesCount });
                    return;
                }
                
            // Mock device data - in real implementation, this would come from API
            const devices = [
                { name: 'iPhone 13', ip: '192.168.1.100', mac: '00:1B:44:11:3A:B7', status: 'online', active: true, lastSeen: null },
                { name: 'MacBook Pro', ip: '192.168.1.101', mac: '00:1B:44:11:3A:B8', status: 'online', active: false, lastSeen: null },
                { name: 'Samsung Galaxy', ip: '192.168.1.103', mac: '00:1B:44:11:3A:BA', status: 'online', active: true, lastSeen: null },
                { name: 'iPad Air', ip: '192.168.1.102', mac: '00:1B:44:11:3A:B9', status: 'offline', active: false, lastSeen: '2 hours ago' },
                { name: 'Windows PC', ip: '192.168.1.104', mac: '00:1B:44:11:3A:BB', status: 'offline', active: false, lastSeen: '1 day ago' }
            ];
            
            // Sort devices: online first, then offline
            const sortedDevices = devices.sort((a, b) => {
                if (a.status === 'online' && b.status === 'offline') return -1;
                if (a.status === 'offline' && b.status === 'online') return 1;
                return 0;
            });
            
            const onlineCount = devices.filter(d => d.status === 'online').length;
            const offlineCount = devices.filter(d => d.status === 'offline').length;
            
            // Update count display
            if (onlineCount > 0) {
                devicesCount.textContent = `${onlineCount} online`;
            } else if (offlineCount > 0) {
                const lastOfflineDevice = devices.filter(d => d.status === 'offline').sort((a, b) => {
                    // Sort by lastSeen time (mock sorting)
                    return a.lastSeen === '1 day ago' ? 1 : -1;
                })[0];
                devicesCount.textContent = `Last seen: ${lastOfflineDevice.lastSeen}`;
            } else {
                devicesCount.textContent = 'No devices';
            }
            
            devicesGrid.innerHTML = '';
            sortedDevices.forEach(device => {
                const deviceCard = document.createElement('div');
                deviceCard.className = `device-card ${device.active ? 'active' : ''}`;
                
                const lastSeenHtml = device.status === 'offline' && device.lastSeen ? 
                    `<div class="device-last-seen">Last seen: ${device.lastSeen}</div>` : '';
                
                deviceCard.innerHTML = `
                    <div class="device-name">${device.name}</div>
                    <div class="device-info">${device.ip} • ${device.mac}</div>
                    <div class="device-status">
                        <div class="status-dot ${device.status === 'online' ? 'online' : ''} ${device.active ? 'active' : ''}"></div>
                        <span>${device.status === 'online' ? (device.active ? 'Active Now' : 'Online') : 'Offline'}</span>
                            </div>
                    ${lastSeenHtml}
                `;
                
                devicesGrid.appendChild(deviceCard);
            });
        }

        function loadProfileActivity(profile) {
            console.log('Loading profile activity for:', profile);
            const categoriesContainer = document.getElementById('app-categories');
            const activeTotal = document.getElementById('active-total');
            
            if (!categoriesContainer || !activeTotal) {
                console.error('Required elements not found:', { categoriesContainer, activeTotal });
                return;
            }
            
            // Mock app category data with timeline sessions
            const categories = [
                {
                    name: 'Social Media',
                    active: true,
                    apps: [
                        { 
                            name: 'Instagram', 
                            time: '2h 15m', 
                            active: true, 
                            icon: 'IG', 
                            device: 'iPhone 13', 
                            lastAccessed: null,
                            sessions: [
                                { start: '09:15', end: '10:30', duration: '1h 15m' },
                                { start: '14:20', end: '15:20', duration: '1h 0m' }
                            ]
                        },
                        { 
                            name: 'TikTok', 
                            time: '1h 30m', 
                            active: false, 
                            icon: 'TT', 
                            device: null, 
                            lastAccessed: '30 min ago',
                            sessions: [
                                { start: '11:00', end: '12:30', duration: '1h 30m' }
                            ]
                        },
                        { 
                            name: 'Facebook', 
                            time: '45m', 
                            active: false, 
                            icon: 'FB', 
                            device: null, 
                            lastAccessed: '1 hour ago',
                            sessions: [
                                { start: '08:00', end: '08:45', duration: '45m' }
                            ]
                        }
                    ]
                },
                {
                    name: 'Entertainment',
                    active: false,
                    apps: [
                        { 
                            name: 'YouTube', 
                            time: '3h 20m', 
                            active: false, 
                            icon: 'YT', 
                            device: null, 
                            lastAccessed: '2 hours ago',
                            sessions: [
                                { start: '13:00', end: '15:20', duration: '2h 20m' },
                                { start: '19:00', end: '20:00', duration: '1h 0m' }
                            ]
                        },
                        { 
                            name: 'Netflix', 
                            time: '1h 45m', 
                            active: false, 
                            icon: 'NF', 
                            device: null, 
                            lastAccessed: '3 hours ago',
                            sessions: [
                                { start: '20:00', end: '21:45', duration: '1h 45m' }
                            ]
                        },
                        { 
                            name: 'Spotify', 
                            time: '2h 10m', 
                            active: true, 
                            icon: 'SP', 
                            device: 'MacBook Pro', 
                            lastAccessed: null,
                            sessions: [
                                { start: '07:30', end: '08:00', duration: '30m' },
                                { start: '16:00', end: '18:00', duration: '2h 0m' }
                            ]
                        }
                    ]
                },
                {
                    name: 'Gaming',
                    active: true,
                    apps: [
                        { 
                            name: 'Discord', 
                            time: '4h 30m', 
                            active: true, 
                            icon: 'DC', 
                            device: 'Samsung Galaxy', 
                            lastAccessed: null,
                            sessions: [
                                { start: '10:00', end: '12:00', duration: '2h 0m' },
                                { start: '15:00', end: '17:30', duration: '2h 30m' }
                            ]
                        },
                        { 
                            name: 'Steam', 
                            time: '2h 15m', 
                            active: false, 
                            icon: 'ST', 
                            device: null, 
                            lastAccessed: '1 hour ago',
                            sessions: [
                                { start: '18:00', end: '20:15', duration: '2h 15m' }
                            ]
                        },
                        { 
                            name: 'PlayStation', 
                            time: '1h 20m', 
                            active: false, 
                            icon: 'PS', 
                            device: null, 
                            lastAccessed: '4 hours ago',
                            sessions: [
                                { start: '21:00', end: '22:20', duration: '1h 20m' }
                            ]
                        }
                    ]
                }
            ];
            
            // Calculate total time across all categories
            let totalMinutes = 0;
            categories.forEach(category => {
                category.apps.forEach(app => {
                    const timeStr = app.time;
                    const hours = parseInt(timeStr.match(/(\d+)h/)?.[1] || '0');
                    const minutes = parseInt(timeStr.match(/(\d+)m/)?.[1] || '0');
                    totalMinutes += (hours * 60) + minutes;
                });
            });
            
            const totalHours = Math.floor(totalMinutes / 60);
            const totalMins = totalMinutes % 60;
            const totalTime = totalHours > 0 ? `${totalHours}h ${totalMins}m` : `${totalMins}m`;
            activeTotal.textContent = totalTime;
            
            categoriesContainer.innerHTML = '';
            categories.forEach(category => {
                const categoryDiv = document.createElement('div');
                categoryDiv.className = 'app-category';
                
                // Calculate total time for category
                const categoryMinutes = category.apps.reduce((total, app) => {
                    const timeStr = app.time;
                    const hours = parseInt(timeStr.match(/(\d+)h/)?.[1] || '0');
                    const minutes = parseInt(timeStr.match(/(\d+)m/)?.[1] || '0');
                    return total + (hours * 60) + minutes;
                }, 0);
                
                const categoryHours = Math.floor(categoryMinutes / 60);
                const categoryMins = categoryMinutes % 60;
                const categoryTime = categoryHours > 0 ? `${categoryHours}h ${categoryMins}m` : `${categoryMins}m`;
                
                const appsHtml = category.apps.map(app => {
                    const deviceInfo = app.active && app.device ? 
                        `<div class="app-device">on ${app.device}</div>` : '';
                    const lastAccessedInfo = !app.active && app.lastAccessed ? 
                        `<div class="app-last-accessed">Last: ${app.lastAccessed}</div>` : '';
                    
                    return `
                        <div class="app-item ${app.active ? 'active' : ''}" onclick="toggleAppTimeline('${app.name.toLowerCase().replace(' ', '-')}')">
                            <div class="app-info">
                                <div class="app-icon">${app.icon}</div>
                                <div>
                                    <div class="app-name">${app.name}</div>
                                    ${deviceInfo}
                                    ${lastAccessedInfo}
                        </div>
                    </div>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <div class="app-time">${app.time}</div>
                                <div class="app-dot ${app.active ? 'active' : ''}"></div>
                            </div>
                        </div>
                        <div class="app-timeline" id="${app.name.toLowerCase().replace(' ', '-')}-timeline">
                            <div class="timeline-sessions">
                                ${app.sessions.map(session => `
                                    <div class="timeline-session">
                                        <div class="timeline-dot"></div>
                                        <div class="timeline-times">
                                            <span>${session.start}</span>
                                            <span>→</span>
                                            <span>${session.end}</span>
                                            <span class="timeline-duration">${session.duration}</span>
                                        </div>
                                    </div>
                            `).join('')}
                            </div>
                        </div>
                    `;
                }).join('');
                
                categoryDiv.innerHTML = `
                    <div class="category-header" onclick="toggleCategory('${category.name.toLowerCase().replace(' ', '-')}')">
                        <div class="category-title">
                            <div class="category-dot ${category.active ? 'active' : ''}"></div>
                            <span>${category.name}</span>
                            <div class="category-total">${categoryTime}</div>
                        </div>
                        <div class="category-icon" id="${category.name.toLowerCase().replace(' ', '-')}-icon">▼</div>
                    </div>
                    <div class="category-apps" id="${category.name.toLowerCase().replace(' ', '-')}-apps">
                        ${appsHtml}
                    </div>
                `;
                
                categoriesContainer.appendChild(categoryDiv);
            });
        }

        function loadProfileAlerts(profile) {
            const alertsList = document.getElementById('alerts-list');
            const alertsBadge = document.getElementById('alerts-badge');
            
            // Mock alert data with seen status
            const alerts = [
                {
                    id: 1,
                    title: 'Blocked Website Access',
                    description: 'Attempted to access restricted content',
                    time: '2 minutes ago',
                    type: 'blocked',
                    seen: false
                },
                {
                    id: 2,
                    title: 'Excessive Screen Time',
                    description: 'Exceeded daily limit for social media apps',
                    time: '15 minutes ago',
                    type: 'warning',
                    seen: false
                },
                {
                    id: 3,
                    title: 'Suspicious Activity',
                    description: 'Unusual network traffic detected',
                    time: '1 hour ago',
                    type: 'security',
                    seen: true
                }
            ];
            
            const unseenCount = alerts.filter(a => !a.seen).length;
            
            if (unseenCount > 0) {
                alertsBadge.textContent = unseenCount;
                alertsBadge.style.display = 'block';
                } else {
                alertsBadge.style.display = 'none';
            }
            
            alertsList.innerHTML = '';
            alerts.forEach(alert => {
                const alertDiv = document.createElement('div');
                alertDiv.className = `alert-item ${alert.seen ? 'seen' : ''}`;
                alertDiv.setAttribute('data-alert-id', alert.id);
                alertDiv.onclick = () => toggleAlertSeen(alert.id);
                
                alertDiv.innerHTML = `
                    <div class="alert-icon">⚠️</div>
                    <div class="alert-content">
                        <div class="alert-title">${alert.title}</div>
                        <div class="alert-description">${alert.description}</div>
                            </div>
                    <div class="alert-time">${alert.time}</div>
                `;
                
                alertsList.appendChild(alertDiv);
            });
        }

        function toggleCategory(categoryId) {
            const apps = document.getElementById(categoryId + '-apps');
            const icon = document.getElementById(categoryId + '-icon');
            
            if (apps.classList.contains('expanded')) {
                apps.classList.remove('expanded');
                icon.classList.remove('expanded');
                } else {
                apps.classList.add('expanded');
                icon.classList.add('expanded');
            }
        }

        // Alert management functions
        function toggleAlertSeen(alertId) {
            // Find the alert item and toggle its seen status
            const alertItem = document.querySelector(`[data-alert-id="${alertId}"]`);
            if (alertItem) {
                alertItem.classList.toggle('seen');
                updateAlertBadge();
            }
        }

        function updateAlertBadge() {
            const alertsList = document.getElementById('alerts-list');
            const alertsBadge = document.getElementById('alerts-badge');
            const unseenAlerts = alertsList.querySelectorAll('.alert-item:not(.seen)');
            
            if (unseenAlerts.length > 0) {
                alertsBadge.textContent = unseenAlerts.length;
                alertsBadge.style.display = 'block';
            } else {
                alertsBadge.textContent = '0';
                alertsBadge.style.display = 'none';
            }
            
            // Update profile card badges on home screen
            updateProfileCardBadges();
        }

        function updateProfileCardBadges() {
            // Get current profile's alert count
            const alertsList = document.getElementById('alerts-list');
            const unseenAlerts = alertsList ? alertsList.querySelectorAll('.alert-item:not(.seen)') : [];
            const alertCount = unseenAlerts.length;
            
            // Update all profile card badges
            const profileCards = document.querySelectorAll('.profile-card');
            profileCards.forEach(card => {
                const badge = card.querySelector('.profile-alert-badge');
                if (badge) {
                    if (alertCount > 0) {
                        badge.textContent = alertCount;
                        badge.style.display = 'block';
                    } else {
                        badge.style.display = 'none';
                    }
                }
            });
        }


        function clearAllAlerts() {
            // In real implementation, this would delete all alerts from database
            console.log('Clearing all alerts');
            const alertsList = document.getElementById('alerts-list');
            const alertsBadge = document.getElementById('alerts-badge');
            
            alertsList.innerHTML = '<div style="text-align: center; color: var(--gray); padding: 20px;">No alerts</div>';
            alertsBadge.style.display = 'none';
            
            // Update profile card badges
            updateProfileCardBadges();
        }

        // App timeline functions
        function toggleAppTimeline(appId) {
            const timeline = document.getElementById(appId + '-timeline');
            
            if (timeline.classList.contains('expanded')) {
                timeline.classList.remove('expanded');
                } else {
                // Close any other open timelines first
                document.querySelectorAll('.app-timeline.expanded').forEach(t => {
                    t.classList.remove('expanded');
                });
                timeline.classList.add('expanded');
            }
        }


        // Data loading functions (placeholder implementations)
        // This function is overridden by the Live tab specific loadLiveData above

        async function loadProfilesData() {
            console.log('Loading profiles data...');
        }

        async function loadDevicesData() {
            console.log('Loading devices data...');
        }

        async function loadHostnamesData() {
            console.log('Loading hostnames data...');
        }

        function startAutoRefresh() {
            // Auto-refresh Live sessions every 3 seconds; Home every 30 seconds
            setInterval(() => {
                if (currentSection === 'live') {
                    // Re-fetch live data quickly
                    initializeLiveData();
                }
            }, 3000);

            setInterval(() => {
                if (currentSection === 'home') {
                    loadProfiles();
                }
            }, 30000);
        }

        function updateAddButtonVisibility() {
            const addContainer = document.getElementById('add-profile-container');
            const bottomButton = document.getElementById('bottom-add-button');
            const modal = document.getElementById('add-profile-modal');
            const profileDetail = document.getElementById('profile-detail-section');
            
            // Only show add controls on Home
            if (currentSection !== 'home') {
                if (addContainer) addContainer.style.display = 'none';
                if (bottomButton) bottomButton.style.display = 'none';
                return;
            }
            
            // Hide add buttons when modal is open or on profile detail screen
            const shouldHide = modal && modal.classList.contains('active') || 
                              profileDetail && profileDetail.classList.contains('active');
            
            if (shouldHide) {
                if (addContainer) addContainer.style.display = 'none';
                if (bottomButton) bottomButton.style.display = 'none';
            } else {
                // Show appropriate button based on whether profiles exist
                const profilesGrid = document.getElementById('profiles-grid');
                const hasProfiles = profilesGrid && profilesGrid.children.length > 0;
                
                if (hasProfiles) {
                    if (addContainer) addContainer.style.display = 'none';
                    if (bottomButton) bottomButton.style.display = 'block';
                } else {
                    if (addContainer) addContainer.style.display = 'flex';
                    if (bottomButton) bottomButton.style.display = 'none';
                }
            }
        }

        // Close sidebar when clicking outside on mobile
        document.addEventListener('click', function(event) {
            if (window.innerWidth <= 768 && sidebarOpen) {
                const sidebar = document.getElementById('sidebar');
                const hamburger = document.getElementById('hamburger');
                
                if (!sidebar.contains(event.target) && !hamburger.contains(event.target)) {
                    closeSidebar();
                }
            }
        });

        // Handle window resize
        window.addEventListener('resize', function() {
            if (window.innerWidth > 768) {
                closeSidebar();
            }
        });

        // ========================================
        // DEVICES SECTION FUNCTIONALITY
        // ========================================

        // Devices data management
        let devicesData = {
            devices: [],
            sortColumn: null,
            sortDirection: 'asc'
        };

        // Device traffic data for modal
        let deviceTrafficData = {
            sessions: [],
            sortColumn: null,
            sortDirection: 'asc'
        };

        // Initialize devices section
        async function initializeDevices() {
            console.log('Initializing devices section...');
            let usedDemo = false;
            try {
                const res = await fetch('/api/devices');
                const data = await res.json();
                if (Array.isArray(data) && data.length > 0) {
                    devicesData.devices = data.map(d => ({
                        id: d.id || 0,
                        name: d.hostname || '',
                        ip: d.ip_address || '',
                        mac: d.mac_address || '',
                        manufacturer: d.vendor || '',
                        status: d.is_active ? 'online' : 'offline',
                        lastSeen: d.last_seen ? new Date(d.last_seen) : new Date()
                    }));
                } else {
                    usedDemo = true;
                }
            } catch (e) {
                usedDemo = true;
            }

            if (usedDemo) {
                loadDevices(); // generate sample and render
                } else {
                renderDevicesTable();
            }
        }

        // ========================================
        // HOSTNAMES MANAGER (CATEGORIES/APPS/RULES)
        // ========================================
        let hnData = {
            categories: [
                // loaded from API
            ],
            apps: [
                // loaded from API
            ],
            rules: [
                // loaded from API
            ],
            selectedCategoryId: null,
            selectedAppId: null
        };

        const HN_API = '/api/hostnames';
        const SETTINGS_API = '/api/settings';

        async function hnBootstrap() {
            try {
                await fetch(`${HN_API}/bootstrap`, { method: 'POST' });
            } catch (e) { console.warn('bootstrap failed', e); }
        }

        async function loadHostnamesData() {
            await hnBootstrap();
            await fetchCategories();
            await fetchApps();
            await fetchRules();
            renderCategories();
            renderApps();
            renderRules();
            updateRulesBadge();
        }

        // ---------- API helpers ----------
        async function fetchCategories() {
            const res = await fetch(`${HN_API}/categories`);
            const json = await res.json();
            hnData.categories = json.categories || [];
        }

        async function createCategoryAPI(payload) {
            const res = await fetch(`${HN_API}/categories`, {
                method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload)
            });
            return res.json();
        }

        async function updateCategoryAPI(id, payload) {
            const res = await fetch(`${HN_API}/categories/${id}`, {
                method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload)
            });
            return res.json();
        }

        async function deleteCategoryAPI(id) {
            await fetch(`${HN_API}/categories/${id}`, { method: 'DELETE' });
        }

        async function fetchApps() {
            const url = hnData.selectedCategoryId ? `${HN_API}/apps?category_id=${hnData.selectedCategoryId}` : `${HN_API}/apps`;
            const res = await fetch(url);
            const json = await res.json();
            hnData.apps = json.apps || [];
        }

        async function createAppAPI(payload) {
            const res = await fetch(`${HN_API}/apps`, {
                method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload)
            });
            return res.json();
        }

        async function updateAppAPI(id, payload) {
            const res = await fetch(`${HN_API}/apps/${id}`, {
                method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload)
            });
            return res.json();
        }

        async function deleteAppAPI(id) { await fetch(`${HN_API}/apps/${id}`, { method: 'DELETE' }); }

        async function fetchRules() {
            const url = hnData.selectedAppId ? `${HN_API}/rules?app_id=${hnData.selectedAppId}` : `${HN_API}/rules`;
            const res = await fetch(url);
            const json = await res.json();
            hnData.rules = json.rules || [];
        }

        async function createRuleAPI(payload) {
            const res = await fetch(`${HN_API}/rules`, {
                method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload)
            });
            return res.json();
        }

        async function updateRuleAPI(id, payload) {
            const res = await fetch(`${HN_API}/rules/${id}`, {
                method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload)
            });
            return res.json();
        }

        async function deleteRuleAPI(id) { await fetch(`${HN_API}/rules/${id}`, { method: 'DELETE' }); }

        function updateRulesBadge() {
            // Heuristic: show count of rules tied to 'Unknown' app or category 'Uncategorized'
            const rulesBadge = document.getElementById('rules-badge');
            if (!rulesBadge) return;
            // Find ids
            const uncCat = hnData.categories.find(c => c.name === 'Uncategorized');
            const unkApp = hnData.apps.find(a => a.name === 'Unknown');
            const uncAppIds = new Set((hnData.apps || []).filter(a => uncCat && a.category_id === uncCat.id).map(a => a.id));
            let count = 0;
            (hnData.rules || []).forEach(r => { if ((unkApp && r.app_id === unkApp.id) || uncAppIds.has(r.app_id)) count++; });
            if (count > 0) { rulesBadge.style.display = 'inline-block'; rulesBadge.textContent = String(count); }
            else { rulesBadge.style.display = 'none'; rulesBadge.textContent = '0'; }
        }

        // ---------- Settings ----------
        async function loadSettings() {
            try {
                const res = await fetch(SETTINGS_API);
                const s = await res.json();
                const idle = document.getElementById('set-idle');
                const ndpi = document.getElementById('set-ndpi');
                if (idle) idle.value = s.session_idle_seconds || 90;
                if (ndpi) ndpi.value = s.ndpi_mode || 'fallback';
                const st = document.getElementById('set-status');
                if (st) st.textContent = '';
            } catch (e) {
                console.warn('loadSettings failed', e);
            }
        }

        async function saveSettings() {
            try {
                const idle = parseInt(document.getElementById('set-idle').value, 10) || 90;
                const ndpi = document.getElementById('set-ndpi').value || 'fallback';
                const res = await fetch(SETTINGS_API, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ session_idle_seconds: idle, ndpi_mode: ndpi })
                });
                const s = await res.json();
                const st = document.getElementById('set-status');
                if (st) st.textContent = 'Saved';
                setTimeout(() => { if (st) st.textContent = ''; }, 1500);
            } catch (e) {
                const st = document.getElementById('set-status');
                if (st) st.textContent = 'Save failed';
            }
        }

        function renderCategories() {
            const list = document.getElementById('hn-categories');
            if (!list) return;
            list.innerHTML = '';
            hnData.categories.forEach(cat => {
                const li = document.createElement('li');
                li.className = 'hn-item';
                li.innerHTML = `
                    <div>
                        <div class="hn-item-title">${cat.name}</div>
                    </div>
                    <div class="hn-actions">
                        <button class="btn btn-small" onclick="editCategory(${cat.id})">Edit</button>
                        <button class="btn btn-small" onclick="deleteCategory(${cat.id})">Delete</button>
                        <button class="btn btn-small" onclick="selectCategory(${cat.id})">Select</button>
                    </div>
                `;
                list.appendChild(li);
            });
        }

        function renderApps() {
            const list = document.getElementById('hn-apps');
            if (!list) return;
            list.innerHTML = '';
            const apps = hnData.selectedCategoryId ? hnData.apps.filter(a => a.categoryId === hnData.selectedCategoryId) : hnData.apps;
            apps.forEach(app => {
                const cat = hnData.categories.find(c => c.id === app.categoryId);
                const li = document.createElement('li');
                li.className = 'hn-item';
                li.innerHTML = `
                    <div>
                        <div class="hn-item-title">${app.name}</div>
                        <div class="hn-item-sub">${cat ? cat.name : ''}</div>
                    </div>
                    <div class="hn-actions">
                        <button class="btn btn-small" onclick="editApp(${app.id})">Edit</button>
                        <button class="btn btn-small" onclick="deleteApp(${app.id})">Delete</button>
                        <button class="btn btn-small" onclick="selectApp(${app.id})">Select</button>
                    </div>
                `;
                list.appendChild(li);
            });
        }

        function renderRules() {
            const list = document.getElementById('hn-rules');
            if (!list) return;
            list.innerHTML = '';
            const rules = hnData.selectedAppId ? hnData.rules.filter(r => r.appId === hnData.selectedAppId) : hnData.rules;
            rules.forEach(rule => {
                const app = hnData.apps.find(a => a.id === rule.appId);
                const li = document.createElement('li');
                li.className = 'hn-item';
                li.innerHTML = `
                    <div>
                        <div class="hn-item-title">${rule.type === 'domain' ? rule.value : rule.value}</div>
                        <div class="hn-item-sub">${app ? app.name : ''} · ${rule.type}</div>
                    </div>
                    <div class="hn-actions">
                        <button class="btn btn-small" onclick="editRule(${rule.id})">Edit</button>
                        <button class="btn btn-small" onclick="deleteRule(${rule.id})">Delete</button>
                    </div>
                `;
                list.appendChild(li);
            });
        }

        // Selection helpers
        function selectCategory(id) { hnData.selectedCategoryId = id; hnData.selectedAppId = null; renderApps(); renderRules(); }
        function selectApp(id) { hnData.selectedAppId = id; renderRules(); }

        // CRUD stubs (to be wired to backend)
        async function showAddCategory() {
            const name = prompt('New category name');
            if (!name) return;
            await createCategoryAPI({ name });
            await fetchCategories();
            renderCategories();
        }
        async function editCategory(id) {
            const cat = hnData.categories.find(c => c.id === id);
            if (!cat) return;
            const name = prompt('Edit category name', cat.name);
            if (name === null) return;
            await updateCategoryAPI(id, { name });
            await fetchCategories();
            renderCategories();
            await fetchApps();
            renderApps();
        }
        async function deleteCategory(id) {
            if (!confirm('Delete category and all its apps/rules?')) return;
            await deleteCategoryAPI(id);
            if (hnData.selectedCategoryId === id) hnData.selectedCategoryId = null;
            await fetchCategories();
            await fetchApps();
            await fetchRules();
            renderCategories(); renderApps(); renderRules();
        }

        async function showAddApp() {
            if (!hnData.selectedCategoryId) { alert('Select a category first'); return; }
            const name = prompt('New app/site name');
            if (!name) return;
            await createAppAPI({ category_id: hnData.selectedCategoryId, name });
            await fetchApps();
            renderApps();
        }
        async function editApp(id) {
            const app = hnData.apps.find(a => a.id === id); if (!app) return;
            const name = prompt('Edit app/site name', app.name);
            if (name === null) return;
            await updateAppAPI(id, { name });
            await fetchApps(); renderApps(); await fetchRules(); renderRules();
        }
        async function deleteApp(id) {
            if (!confirm('Delete app and all its rules?')) return;
            await deleteAppAPI(id);
            if (hnData.selectedAppId === id) hnData.selectedAppId = null;
            await fetchApps(); await fetchRules(); renderApps(); renderRules();
        }

        async function showAddRule() {
            if (!hnData.selectedAppId) { alert('Select an app/site first'); return; }
            const type = prompt('Rule type: domain or ip', 'domain');
            const value = prompt('Enter domain or IP');
            if (!value) return;
            await createRuleAPI({ app_id: hnData.selectedAppId, type: (type === 'ip' ? 'ip' : 'domain'), value });
            await fetchRules(); renderRules();
        }
        async function editRule(id) {
            const r = hnData.rules.find(x => x.id === id); if (!r) return;
            const value = prompt('Edit value', r.value); if (value === null) return;
            await updateRuleAPI(id, { value });
            await fetchRules(); renderRules();
        }
        async function deleteRule(id) {
            if (!confirm('Delete rule?')) return;
            await deleteRuleAPI(id);
            await fetchRules(); renderRules();
        }
        // Load devices data
        function loadDevices() {
            console.log('Loading devices...');
            
            // Generate sample devices data
            const sampleDevices = [
                {
                    id: 1,
                    name: 'iPhone 12 Pro',
                    ip: '192.168.1.100',
                    mac: '00:1B:44:11:3A:B7',
                    manufacturer: 'Apple',
                    model: 'iPhone 12 Pro',
                    status: 'online',
                    lastSeen: new Date(Date.now() - 5 * 60 * 1000), // 5 minutes ago
                    profile: 'John Doe'
                },
                {
                    id: 2,
                    name: 'MacBook Pro',
                    ip: '192.168.1.101',
                    mac: '00:1B:44:11:3A:B8',
                    manufacturer: 'Apple',
                    model: 'MacBook Pro 13"',
                    status: 'online',
                    lastSeen: new Date(Date.now() - 2 * 60 * 1000), // 2 minutes ago
                    profile: 'John Doe'
                },
                {
                    id: 3,
                    name: 'Samsung Galaxy S21',
                    ip: '192.168.1.102',
                    mac: '00:1B:44:11:3A:B9',
                    manufacturer: 'Samsung',
                    model: 'Galaxy S21',
                    status: 'offline',
                    lastSeen: new Date(Date.now() - 2 * 60 * 60 * 1000), // 2 hours ago
                    profile: 'Jane Smith'
                },
                {
                    id: 4,
                    name: 'Gaming PC',
                    ip: '192.168.1.103',
                    mac: '00:1B:44:11:3A:BA',
                    manufacturer: 'Custom Build',
                    model: 'Gaming Desktop',
                    status: 'online',
                    lastSeen: new Date(Date.now() - 1 * 60 * 1000), // 1 minute ago
                    profile: 'Kids'
                },
                {
                    id: 5,
                    name: 'iPad Air',
                    ip: '192.168.1.104',
                    mac: '00:1B:44:11:3A:BB',
                    manufacturer: 'Apple',
                    model: 'iPad Air 4th Gen',
                    status: 'offline',
                    lastSeen: new Date(Date.now() - 30 * 60 * 1000), // 30 minutes ago
                    profile: 'Kids'
                },
                {
                    id: 6,
                    name: 'Router',
                    ip: '192.168.1.1',
                    mac: '00:1B:44:11:3A:BC',
                    manufacturer: 'Netgear',
                    model: 'Nighthawk AX8',
                    status: 'online',
                    lastSeen: new Date(Date.now() - 10 * 1000), // 10 seconds ago
                    profile: 'System'
                }
            ];

            devicesData.devices = sampleDevices;
            renderDevicesTable();
        }

        // Render devices table
        function renderDevicesTable() {
            console.log('Rendering devices table...');
            const tbody = document.getElementById('devices-table-body');
            if (!tbody) {
                console.warn('devices-table-body not ready, retrying next frame');
                return requestAnimationFrame(renderDevicesTable);
            }

            tbody.innerHTML = '';

            devicesData.devices.forEach((device, idx) => {
                const row = document.createElement('tr');
                row.className = 'clickable-row';
                row.onclick = () => toggleDeviceExpander(idx);
                row.innerHTML = `
                    <td>
                        <div class="device-info">
                            <div class="device-name">${device.name || ''}</div>
                            <div class="device-ip">${device.ip}</div>
                            <div class="device-mac">${device.mac}</div>
                    </div>
                    </td>
                    <td>
                        ${device.manufacturer}
                    </td>
                    <td>
                        <div class="session-status">
                            <div class="status-dot ${device.status === 'online' ? 'status-active' : 'status-inactive'} ${device.status === 'online' ? 'pulse' : ''}"></div>
                            ${device.status === 'online' ? 'Online' : `Offline · ${formatLastSeen(device.lastSeen)}`}
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // Format last seen time
        function formatLastSeen(date) {
            const now = new Date();
            const diff = now - date;
            const minutes = Math.floor(diff / 60000);
            const hours = Math.floor(minutes / 60);
            const days = Math.floor(hours / 24);

            if (minutes < 1) return 'Just now';
            if (minutes < 60) return `${minutes}m ago`;
            if (hours < 24) return `${hours}h ago`;
            return `${days}d ago`;
        }

        // Sort devices table
        function sortDevicesTable(column) {
            console.log(`Sorting devices by: ${column}`);
            
            if (devicesData.sortColumn === column) {
                if (devicesData.sortDirection === 'asc') {
                    devicesData.sortDirection = 'desc';
                } else if (devicesData.sortDirection === 'desc') {
                    devicesData.sortColumn = null;
                    devicesData.sortDirection = null;
                    updateDevicesSortIndicators(null);
                    renderDevicesTable();
                    return;
                }
                } else {
                devicesData.sortColumn = column;
                devicesData.sortDirection = 'asc';
            }

            devicesData.devices.sort((a, b) => {
                let aVal = a[column];
                let bVal = b[column];

                // Handle special cases
                if (column === 'lastSeen') {
                    aVal = a.lastSeen.getTime();
                    bVal = b.lastSeen.getTime();
                }

                if (typeof aVal === 'string') {
                    aVal = aVal.toLowerCase();
                    bVal = bVal.toLowerCase();
                }

                if (devicesData.sortDirection === 'asc') {
                    return aVal > bVal ? 1 : -1;
                } else {
                    return aVal < bVal ? 1 : -1;
                }
            });

            // Update sort indicators
            updateDevicesSortIndicators(column);
            renderDevicesTable();
        }

        // Update sort indicators for devices table (↕/↑/↓)
        function updateDevicesSortIndicators(activeColumn) {
            document.querySelectorAll('#devices-table th.sortable, #devices-table th[data-sort]')
                .forEach(header => {
                    const icon = header.querySelector('.sort-icon');
                    const col = header.dataset.sort || null;
                    if (!icon || !col) return;
                    if (!activeColumn || devicesData.sortColumn !== activeColumn || col !== activeColumn) {
                        icon.textContent = '↕';
                    return;
                    }
                    icon.textContent = devicesData.sortDirection === 'asc' ? '↑' : '↓';
                });
        }

        // Toggle device expander
        async function toggleDeviceExpander(deviceIdx) {
            console.log(`Toggling device expander for device index: ${deviceIdx}`);
            
            const device = devicesData.devices[deviceIdx];
            if (!device) {
                console.error('Device not found');
                return;
            }

            const expander = document.getElementById('device-expander');
            if (!expander) return;

            // Check if this device is already expanded
            const isCurrentlyExpanded = expander.style.display !== 'none' && 
                                      expander.dataset.deviceIdx == String(deviceIdx);

            if (isCurrentlyExpanded) {
                // Hide expander
                expander.style.display = 'none';
                expander.dataset.deviceIdx = '';
            } else {
                // Show expander for this device
                expander.style.display = 'block';
                expander.dataset.deviceIdx = String(deviceIdx);

                // Set friendly name input
                const nameInput = document.getElementById('device-friendly-name');
                if (nameInput) {
                    nameInput.value = device.name || '';
                    nameInput.placeholder = 'Enter friendly name...';
                }

                // Initialize device traffic data
                deviceTrafficData = {
                    sessions: [],
                    sortColumn: null,
                    sortDirection: 'asc',
                    timeRange: '15min',
                    alerts: false
                };

                // Load device traffic sessions from backend if available
                try {
                    let mac = device.mac;
                    if (!mac && device.ip) {
                        // fallback: try to find device by IP in backend later if needed
                    }
                    if (mac) {
                        const res = await fetch(`/api/traffic/devices/${encodeURIComponent(mac)}?hours=24`);
                        const data = await res.json();
                        if (Array.isArray(data)) {
                            deviceTrafficData.sessions = data.map(s => ({
                                device: device.name || device.ip || mac,
                                deviceIp: s.src_ip || device.ip || '',
                                category: s.category || 'Uncategorized',
                                categoryId: s.category_id || 0,
                                app: s.app || s.hostname || s.dst_ip || 'Unknown',
                                appId: s.app_id || 0,
                                startTime: s.start_time,
                                endTime: s.end_time,
                                duration: Math.max(1, Math.floor(((new Date(s.end_time || Date.now())) - (new Date(s.start_time))) / 60000)),
                                dataBytes: (s.bytes_sent || 0) + (s.bytes_received || 0),
                                isActive: !s.end_time
                            }));
                        } else {
                            // Fallback to sample
                            loadDeviceTrafficSessions(deviceIdx);
                        }
                    } else {
                        loadDeviceTrafficSessions(deviceIdx);
                    }
                } catch (e) {
                    console.warn('device sessions fetch failed, fallback to sample', e);
                    loadDeviceTrafficSessions(deviceIdx);
                }
            }
        }

        // Load device information
        function loadDeviceInfo(device) {
            const grid = document.getElementById('device-info-grid');
            if (!grid) return;

            grid.innerHTML = `
                <div class="device-info-item">
                    <div class="device-info-label">Device Name</div>
                    <div class="device-info-value">${device.name}</div>
                </div>
                <div class="device-info-item">
                    <div class="device-info-label">IP Address</div>
                    <div class="device-info-value">${device.ip}</div>
                </div>
                <div class="device-info-item">
                    <div class="device-info-label">MAC Address</div>
                    <div class="device-info-value">${device.mac}</div>
                </div>
                <div class="device-info-item">
                    <div class="device-info-label">Manufacturer</div>
                    <div class="device-info-value">${device.manufacturer}</div>
                </div>
                <div class="device-info-item">
                    <div class="device-info-label">Model</div>
                    <div class="device-info-value">${device.model}</div>
                </div>
                <div class="device-info-item">
                    <div class="device-info-label">Status</div>
                    <div class="device-info-value">${device.status === 'online' ? 'Online' : 'Offline'}</div>
                </div>
                <div class="device-info-item">
                    <div class="device-info-label">Last Seen</div>
                    <div class="device-info-value">${formatLastSeen(device.lastSeen)}</div>
                </div>
                <div class="device-info-item">
                    <div class="device-info-label">Assigned Profile</div>
                    <div class="device-info-value">${device.profile}</div>
                </div>
            `;
        }

        // Load device traffic sessions
        function loadDeviceTrafficSessions(deviceIdx) {
            console.log(`Loading traffic sessions for device index: ${deviceIdx}`);
            
            // Generate sample traffic sessions for this device
            const device = devicesData.devices[deviceIdx];
            if (!device) return;

            const sampleSessions = [
                {
                    id: 1,
                    device: device.name || 'Unknown Device',
                    deviceIp: device.ip,
                    category: 'Social Media',
                    categoryId: 1,
                    app: 'Instagram',
                    appId: 1,
                    startTime: new Date(Date.now() - 15 * 60 * 1000),
                    endTime: new Date(Date.now() - 10 * 60 * 1000),
                    duration: 5 * 60 * 1000,
                    dataBytes: 2.5 * 1024 * 1024,
                    isActive: false,
                    hasAlert: false
                },
                {
                    id: 2,
                    device: device.name || 'Unknown Device',
                    deviceIp: device.ip,
                    category: 'Entertainment',
                    categoryId: 5,
                    app: 'YouTube',
                    appId: 5,
                    startTime: new Date(Date.now() - 30 * 60 * 1000),
                    endTime: new Date(Date.now() - 5 * 60 * 1000),
                    duration: 25 * 60 * 1000,
                    dataBytes: 15.2 * 1024 * 1024,
                    isActive: true,
                    hasAlert: true
                },
                {
                    id: 3,
                    device: device.name || 'Unknown Device',
                    deviceIp: device.ip,
                    category: 'Gaming',
                    categoryId: 3,
                    app: 'Steam',
                    appId: 3,
                    startTime: new Date(Date.now() - 45 * 60 * 1000),
                    endTime: new Date(Date.now() - 20 * 60 * 1000),
                    duration: 25 * 60 * 1000,
                    dataBytes: 45.8 * 1024 * 1024,
                    isActive: false,
                    hasAlert: false
                }
            ];

            // Apply time range filter
            let filteredSessions = sampleSessions.filter(session => {
                const now = new Date();
                const sessionTime = session.startTime;
                const timeDiff = now - sessionTime;
                
                switch (deviceTrafficData.timeRange) {
                    case '15min':
                        return timeDiff <= 15 * 60 * 1000;
                    case '1hour':
                        return timeDiff <= 60 * 60 * 1000;
                    case '2hours':
                        return timeDiff <= 2 * 60 * 60 * 1000;
                    case 'daily':
                        return timeDiff <= 24 * 60 * 60 * 1000;
                    default:
                        return true;
                }
            });

            // Apply alert filter
            if (deviceTrafficData.alerts) {
                filteredSessions = filteredSessions.filter(session => session.hasAlert);
            }

            deviceTrafficData.sessions = filteredSessions;
            renderDeviceTrafficTable();
            updateDeviceAlertBadge();
        }

        // Render device traffic table
        function renderDeviceTrafficTable() {
            const tbody = document.getElementById('device-traffic-table-body');
            if (!tbody) return;

            tbody.innerHTML = '';

            deviceTrafficData.sessions.forEach(session => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>
                        <div class="device-info">
                            <div class="device-name">${session.device}</div>
                            <div class="device-ip">${session.deviceIp}</div>
                        </div>
                    </td>
                    <td>
                        <span class="category-badge category-${session.categoryId}">${session.category}</span>
                    </td>
                    <td>
                        <div class="accessing-info">
                            <div class="accessing-app">${session.app}</div>
                            <div class="accessing-time">${formatTime(session.startTime)}</div>
                        </div>
                    </td>
                    <td>
                        <div class="duration-info">${formatDuration(session.duration)}</div>
                    </td>
                    <td>
                        <div class="data-info">${formatDataBytes(session.dataBytes)}</div>
                    </td>
                    <td>
                        <div class="session-status">
                            <div class="status-dot ${session.isActive ? 'status-active' : 'status-inactive'}"></div>
                            ${session.isActive ? 'Active' : 'Inactive'}
                        </div>
                    </td>
                `;
                const qa = document.createElement('td');
                qa.innerHTML = `<div class="quick-actions"><span class="quick-action" onclick="event.stopPropagation(); quickAddRule('${session.app}', '${session.category}', '${session.deviceIp}', '${session.hostname || ''}')">Add rule</span></div>`;
                row.appendChild(qa);
                tbody.appendChild(row);
            });
        }

        // Update device alert badge
        function updateDeviceAlertBadge() {
            const badge = document.getElementById('device-alert-badge');
            const count = badge?.querySelector('.alert-count');
            if (count) {
                const alertCount = deviceTrafficData.sessions.filter(s => s.hasAlert).length;
                count.textContent = alertCount;
            }
        }

        // Filter device traffic by clicked value
        function filterDeviceTrafficByValue(column, value) {
            console.log(`Filtering device traffic by: ${column} = ${value}`);
            // This would filter the device traffic table by the clicked value
            // For now, just log the action
        }

        // Sort device traffic table
        function sortDeviceTrafficTable(column) {
            console.log(`Sorting device traffic by: ${column}`);
            
            if (deviceTrafficData.sortColumn === column) {
                if (deviceTrafficData.sortDirection === 'asc') {
                    deviceTrafficData.sortDirection = 'desc';
                } else if (deviceTrafficData.sortDirection === 'desc') {
                    deviceTrafficData.sortColumn = null;
                    deviceTrafficData.sortDirection = null;
                    updateDeviceTrafficSortIndicators(null);
                    renderDeviceTrafficTable();
                    return;
                }
                } else {
                deviceTrafficData.sortColumn = column;
                deviceTrafficData.sortDirection = 'asc';
            }

            deviceTrafficData.sessions.sort((a, b) => {
                let aVal = a[column];
                let bVal = b[column];

                if (column === 'startTime') {
                    aVal = a.startTime.getTime();
                    bVal = b.startTime.getTime();
                }

                if (typeof aVal === 'string') {
                    aVal = aVal.toLowerCase();
                    bVal = bVal.toLowerCase();
                }

                if (deviceTrafficData.sortDirection === 'asc') {
                    return aVal > bVal ? 1 : -1;
                } else {
                    return aVal < bVal ? 1 : -1;
                }
            });

            updateDeviceTrafficSortIndicators(column);
            renderDeviceTrafficTable();
        }

        // Update sort indicators for device traffic table
        function updateDeviceTrafficSortIndicators(activeColumn) {
            const headers = document.querySelectorAll('#device-traffic-table th.sortable');
            headers.forEach(header => {
                const indicator = header.querySelector('.sort-indicator');
                const column = header.getAttribute('onclick').match(/'([^']+)'/)[1];
                
                if (column === activeColumn && deviceTrafficData.sortColumn === activeColumn) {
                    indicator.textContent = deviceTrafficData.sortDirection === 'asc' ? ' ↑' : ' ↓';
                } else {
                    indicator.textContent = '';
                }
            });
        }

        // Close device expander
        function closeDeviceExpander() {
            const expander = document.getElementById('device-expander');
            if (expander) {
                expander.style.display = 'none';
                expander.dataset.deviceIdx = '';
            }
        }

        // Refresh devices
        function refreshDevices() {
            console.log('Refreshing devices...');
            loadDevices();
        }

        // Scan network for new devices
        function scanNetwork() {
            console.log('Scanning network for new devices...');
            // This would trigger a network scan
            // For now, just refresh the devices
            refreshDevices();
        }

        // Device name editing functions
        function saveDeviceName() {
            const nameInput = document.getElementById('device-friendly-name');
            if (!nameInput) return;

            const expander = document.getElementById('device-expander');
            if (!expander || !expander.dataset.deviceIdx) return;

            const deviceIdx = parseInt(expander.dataset.deviceIdx);
            const device = devicesData.devices[deviceIdx];
            if (!device) return;

            const newName = nameInput.value.trim();
            console.log(`Saving device name: ${newName} for device index: ${deviceIdx}`);
            
            // Update device name
            device.name = newName;
            
            // Re-render the devices table to show updated name
            renderDevicesTable();
            
            // In a real implementation, this would update the device in the database
        }

        function handleDeviceNameKeypress(event) {
            if (event.key === 'Enter') {
                saveDeviceName();
                event.target.blur();
            }
        }

        function clearDeviceName() {
            const nameInput = document.getElementById('device-friendly-name');
            if (nameInput) {
                nameInput.value = '';
                nameInput.focus();
            }
        }

        // Device time range functions
        function setDeviceTimeRange(timeRange) {
            console.log(`Setting device time range: ${timeRange}`);
            
            // Update active tab
            document.querySelectorAll('.device-time-filters .time-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');

            // Update device traffic data
            deviceTrafficData.timeRange = timeRange;
            
            // Get current device index from expander
            const expander = document.getElementById('device-expander');
            if (!expander || !expander.dataset.deviceIdx) return;
            
            const deviceIdx = parseInt(expander.dataset.deviceIdx);
            
            // Reload traffic sessions
            loadDeviceTrafficSessions(deviceIdx);
        }

        function toggleDeviceAlertFilter() {
            console.log('Toggling device alert filter');
            
            deviceTrafficData.alerts = !deviceTrafficData.alerts;
            
            // Update button appearance
            const badge = document.getElementById('device-alert-badge');
            if (badge) {
                badge.classList.toggle('active', deviceTrafficData.alerts);
            }
            
            // Get current device index from expander
            const expander = document.getElementById('device-expander');
            if (!expander || !expander.dataset.deviceIdx) return;
            
            const deviceIdx = parseInt(expander.dataset.deviceIdx);
            
            // Reload traffic sessions
            loadDeviceTrafficSessions(deviceIdx);
        }

        // ========================================
        // QUICK ADD RULE (from session rows)
        // ========================================
        async function quickAddRule(appName, categoryName, ip, hostname) {
            try {
                await hnBootstrap();
                await fetchCategories();
                // Category
                let category = hnData.categories.find(c => c.name.toLowerCase() === (categoryName||'').toLowerCase());
                if (!category) {
                    category = await createCategoryAPI({ name: categoryName || 'Uncategorized' });
                    await fetchCategories();
                }
                const categoryId = category.id || (hnData.categories.find(c => c.name === category.name)?.id);
                // App
                hnData.selectedCategoryId = categoryId;
                await fetchApps();
                let app = hnData.apps.find(a => a.name.toLowerCase() === (appName||'').toLowerCase());
                if (!app) {
                    app = await createAppAPI({ category_id: categoryId, name: appName || (hostname||ip||'Unknown') });
                    await fetchApps();
                }
                const appId = app.id || (hnData.apps.find(a => a.name === app.name)?.id);
                // Rule
                const isDomain = hostname && hostname.includes('.') && !/^[0-9.]+$/.test(hostname);
                await createRuleAPI({ app_id: appId, type: isDomain ? 'domain' : 'ip', value: isDomain ? hostname : ip });
                // Navigate to Rules tab and focus context
                showSection('rules');
                hnData.selectedCategoryId = categoryId;
                await fetchApps();
                hnData.selectedAppId = appId;
                await fetchRules();
                renderCategories(); renderApps(); renderRules();
                alert('Rule added successfully in Rules tab');
            } catch (e) {
                console.error('quickAddRule error', e);
                alert('Could not add rule');
            }
        }

        // ========================================
        // FIXED CELL CLICKING BEHAVIOR
        // ========================================

        // Fixed filterByValue function for Live table
        function filterByValue(column, value) {
            console.log(`Adding filter: ${column} = ${value}`);
            
            // Add appropriate filter based on column
            switch (column) {
                case 'device':
                    // Filter by device name directly, not by profile
                    if (!liveData.filters.devices.includes(value)) {
                        liveData.filters.devices.push(value);
                        updateActiveFilters();
                        loadSessionsTable();
                    }
                    break;
                case 'category':
                    if (!liveData.filters.categories.includes(value)) {
                        toggleCategoryFilter(value);
                    }
                    break;
                case 'app':
                    if (!liveData.filters.apps.includes(value)) {
                        toggleAppFilter(value);
                    }
                    break;
                case 'duration':
                    // Filter by duration range
                    if (!liveData.filters.durations.includes(value)) {
                        liveData.filters.durations.push(value);
                        updateActiveFilters();
                        loadSessionsTable();
                    }
                    break;
                case 'data':
                    // Filter by data range
                    if (!liveData.filters.dataRanges.includes(value)) {
                        liveData.filters.dataRanges.push(value);
                        updateActiveFilters();
                        loadSessionsTable();
                    }
                    break;
                case 'status':
                    // Filter by status
                    if (!liveData.filters.statuses.includes(value)) {
                        liveData.filters.statuses.push(value);
                        updateActiveFilters();
                        loadSessionsTable();
                    }
                    break;
            }
        }

        // Add device filters to liveData
        if (typeof liveData !== 'undefined') {
            liveData.filters.devices = liveData.filters.devices || [];
            liveData.filters.durations = liveData.filters.durations || [];
            liveData.filters.dataRanges = liveData.filters.dataRanges || [];
            liveData.filters.statuses = liveData.filters.statuses || [];
        }
    </script>
</body>
</html>
</html>
</html>